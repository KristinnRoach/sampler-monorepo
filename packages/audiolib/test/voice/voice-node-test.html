<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoiceNode Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .controls {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .control-group {
      margin-bottom: 10px;
    }
    button {
      padding: 8px 12px;
      margin-right: 10px;
      cursor: pointer;
    }
    label {
      margin-right: 10px;
    }
    select, input {
      padding: 5px;
      margin-right: 10px;
    }
    .envelope-params {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .envelope-param {
      display: flex;
      flex-direction: column;
    }
    .envelope-param input {
      width: 100%;
    }
    .log {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>VoiceNode Test</h1>
  
  <div class="controls">
    <div class="control-group">
      <button id="init-audio">Initialize Audio</button>
      <span id="status">Audio not initialized</span>
    </div>
    
    <div class="control-group">
      <label for="sample-select">Sample:</label>
      <select id="sample-select" disabled>
        <option value="guitar">Guitar</option>
        <option value="piano">Piano</option>
        <option value="drum">Drum</option>
      </select>
      
      <button id="load-sample" disabled>Load Sample</button>
    </div>
    
    <div class="control-group">
      <button id="play" disabled>Play</button>
      <button id="release" disabled>Release</button>
      <button id="stop" disabled>Stop</button>
    </div>
    
    <div class="control-group">
      <label>
        <input type="checkbox" id="loop-toggle" disabled>
        Loop
      </label>
      
      <div id="loop-controls" style="display: none; margin-top: 10px;">
        <div>
          <label for="loop-start">Loop Start:</label>
          <input type="range" id="loop-start" min="0" max="1" step="0.01" value="0" disabled>
          <span id="loop-start-value">0.00s</span>
        </div>
        <div>
          <label for="loop-end">Loop End:</label>
          <input type="range" id="loop-end" min="0" max="1" step="0.01" value="1" disabled>
          <span id="loop-end-value">1.00s</span>
        </div>
      </div>
    </div>
    
    <div class="control-group">
      <label for="envelope-type">Envelope Type:</label>
      <select id="envelope-type" disabled>
        <option value="ar">AR (Attack-Release)</option>
        <option value="adsr">ADSR (Attack-Decay-Sustain-Release)</option>
      </select>
      
      <div class="envelope-params">
        <div class="envelope-param">
          <label for="attack">Attack:</label>
          <input type="range" id="attack" min="0.001" max="2" step="0.001" value="0.01" disabled>
          <span id="attack-value">0.01s</span>
        </div>
        
        <div class="envelope-param adsr-param" style="display: none;">
          <label for="decay">Decay:</label>
          <input type="range" id="decay" min="0.001" max="2" step="0.001" value="0.1" disabled>
          <span id="decay-value">0.10s</span>
        </div>
        
        <div class="envelope-param adsr-param" style="display: none;">
          <label for="sustain">Sustain:</label>
          <input type="range" id="sustain" min="0" max="1" step="0.01" value="0.7" disabled>
          <span id="sustain-value">0.70</span>
        </div>
        
        <div class="envelope-param">
          <label for="release">Release:</label>
          <input type="range" id="release-param" min="0.001" max="5" step="0.001" value="0.3" disabled>
          <span id="release-value">0.30s</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="log" id="log"></div>

  <script type="module">
    // We'll need to replace this with the actual path to the VoiceNode module
    import { VoiceNode, EnvelopeType } from '../../dist/index.js';
    
    // State
    let audioContext = null;
    let voiceNode = null;
    let currentSample = null;
    const sampleBuffers = {};
    const sampleURLs = {
      'guitar': '../../src/audio-samples/guitar.mp3',
      'piano': '../../src/audio-samples/c4.mp3',
      'drum': '../../src/audio-samples/Kit03-120C-04.wav'
    };
    
    // Elements
    const initBtn = document.getElementById('init-audio');
    const statusSpan = document.getElementById('status');
    const sampleSelect = document.getElementById('sample-select');
    const loadSampleBtn = document.getElementById('load-sample');
    const playBtn = document.getElementById('play');
    const releaseBtn = document.getElementById('release');
    const stopBtn = document.getElementById('stop');
    const loopToggle = document.getElementById('loop-toggle');
    const loopControls = document.getElementById('loop-controls');
    const loopStart = document.getElementById('loop-start');
    const loopEnd = document.getElementById('loop-end');
    const loopStartValue = document.getElementById('loop-start-value');
    const loopEndValue = document.getElementById('loop-end-value');
    const envelopeType = document.getElementById('envelope-type');
    const attackSlider = document.getElementById('attack');
    const decaySlider = document.getElementById('decay');
    const sustainSlider = document.getElementById('sustain');
    const releaseSlider = document.getElementById('release-param');
    const attackValue = document.getElementById('attack-value');
    const decayValue = document.getElementById('decay-value');
    const sustainValue = document.getElementById('sustain-value');
    const releaseValue = document.getElementById('release-value');
    const adsrParams = document.querySelectorAll('.adsr-param');
    const logElement = document.getElementById('log');
    
    // Helpers
    function log(message) {
      const entry = document.createElement('div');
      entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
      logElement.appendChild(entry);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    function enableControls(enabled) {
      sampleSelect.disabled = !enabled;
      loadSampleBtn.disabled = !enabled;
      loopToggle.disabled = !enabled;
      envelopeType.disabled = !enabled;
      attackSlider.disabled = !enabled;
      decaySlider.disabled = !enabled;
      sustainSlider.disabled = !enabled;
      releaseSlider.disabled = !enabled;
    }
    
    function updatePlaybackControls() {
      const sampleLoaded = currentSample !== null;
      playBtn.disabled = !sampleLoaded || (voiceNode && voiceNode.isActive());
      releaseBtn.disabled = !sampleLoaded || !voiceNode || !voiceNode.isActive() || voiceNode.isInRelease();
      stopBtn.disabled = !sampleLoaded || !voiceNode || !voiceNode.isActive();
    }
    
    // Event Handlers
    initBtn.addEventListener('click', async () => {
      try {
        audioContext = new AudioContext();
        statusSpan.textContent = `Audio initialized (${audioContext.sampleRate}Hz)`;
        
        voiceNode = new VoiceNode(audioContext);
        voiceNode.connect(audioContext.destination);
        
        enableControls(true);
        log('Audio context and VoiceNode initialized');
      } catch (err) {
        log(`Error initializing audio: ${err.message}`);
        statusSpan.textContent = 'Error initializing audio';
      }
    });
    
    loadSampleBtn.addEventListener('click', async () => {
      const sampleName = sampleSelect.value;
      
      try {
        // Check if we already have this sample loaded
        if (sampleBuffers[sampleName]) {
          currentSample = sampleBuffers[sampleName];
          voiceNode.setBuffer(currentSample);
          log(`Loaded cached sample: ${sampleName}`);
          updatePlaybackControls();
          return;
        }
        
        // Load the sample
        log(`Loading sample: ${sampleName} from ${sampleURLs[sampleName]}`);
        const response = await fetch(sampleURLs[sampleName]);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        // Store and set as current
        sampleBuffers[sampleName] = audioBuffer;
        currentSample = audioBuffer;
        
        // Update loop controls range
        loopStart.max = audioBuffer.duration;
        loopEnd.max = audioBuffer.duration;
        loopEnd.value = audioBuffer.duration;
        loopStartValue.textContent = '0.00s';
        loopEndValue.textContent = `${audioBuffer.duration.toFixed(2)}s`;
        
        // Set in VoiceNode
        voiceNode.setBuffer(currentSample);
        log(`Sample loaded: ${sampleName} (${audioBuffer.duration.toFixed(2)}s)`);
        
        updatePlaybackControls();
      } catch (err) {
        log(`Error loading sample: ${err.message}`);
      }
    });
    
    playBtn.addEventListener('click', () => {
      if (!voiceNode || !currentSample) return;
      
      voiceNode.start();
      log('Playback started');
      updatePlaybackControls();
    });
    
    releaseBtn.addEventListener('click', () => {
      if (!voiceNode || !voiceNode.isActive()) return;
      
      voiceNode.release();
      log('Release triggered');
      updatePlaybackControls();
    });
    
    stopBtn.addEventListener('click', () => {
      if (!voiceNode || !voiceNode.isActive()) return;
      
      voiceNode.stop();
      log('Playback stopped');
      updatePlaybackControls();
    });
    
    loopToggle.addEventListener('change', async () => {
      if (!voiceNode) return;
      
      const shouldLoop = loopToggle.checked;
      loopControls.style.display = shouldLoop ? 'block' : 'none';
      
      if (shouldLoop) {
        const loopStartTime = parseFloat(loopStart.value);
        const loopEndTime = parseFloat(loopEnd.value);
        await voiceNode.setLoop(true, loopStartTime, loopEndTime);
        log(`Looping enabled: ${loopStartTime.toFixed(2)}s to ${loopEndTime.toFixed(2)}s`);
      } else {
        await voiceNode.setLoop(false);
        log('Looping disabled');
      }
    });
    
    loopStart.addEventListener('input', async () => {
      const startTime = parseFloat(loopStart.value);
      loopStartValue.textContent = `${startTime.toFixed(2)}s`;
      
      if (voiceNode && loopToggle.checked) {
        const endTime = parseFloat(loopEnd.value);
        await voiceNode.setLoop(true, startTime, endTime);
      }
    });
    
    loopEnd.addEventListener('input', async () => {
      const endTime = parseFloat(loopEnd.value);
      loopEndValue.textContent = `${endTime.toFixed(2)}s`;
      
      if (voiceNode && loopToggle.checked) {
        const startTime = parseFloat(loopStart.value);
        await voiceNode.setLoop(true, startTime, endTime);
      }
    });
    
    envelopeType.addEventListener('change', () => {
      const isADSR = envelopeType.value === 'adsr';
      
      // Show/hide ADSR-specific controls
      adsrParams.forEach(elem => {
        elem.style.display = isADSR ? 'block' : 'none';
      });
      
      updateEnvelope();
    });
    
    // Sliders for envelope parameters
    [attackSlider, decaySlider, sustainSlider, releaseSlider].forEach(slider => {
      slider.addEventListener('input', () => {
        // Update displayed values
        attackValue.textContent = `${parseFloat(attackSlider.value).toFixed(2)}s`;
        decayValue.textContent = `${parseFloat(decaySlider.value).toFixed(2)}s`;
        sustainValue.textContent = parseFloat(sustainSlider.value).toFixed(2);
        releaseValue.textContent = `${parseFloat(releaseSlider.value).toFixed(2)}s`;
        
        updateEnvelope();
      });
    });
    
    function updateEnvelope() {
      if (!voiceNode) return;
      
      const isADSR = envelopeType.value === 'adsr';
      const type = isADSR ? EnvelopeType.ADSR : EnvelopeType.AR;
      
      const params = {
        attack: parseFloat(attackSlider.value),
        release: parseFloat(releaseSlider.value)
      };
      
      if (isADSR) {
        params.decay = parseFloat(decaySlider.value);
        params.sustain = parseFloat(sustainSlider.value);
      }
      
      voiceNode.setEnvelope(type, params);
      log(`Envelope updated: ${isADSR ? 'ADSR' : 'AR'} with params ${JSON.stringify(params)}`);
    }
    
    // Initialize with default state
    updatePlaybackControls();
    log('Test page loaded');
  </script>
</body>
</html>
