<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PseudoAudioParam loopEnd Tester</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .slider-container {
        margin: 20px 0;
      }
      input[type='range'] {
        width: 100%;
        margin: 10px 0;
      }
      .value-display {
        display: inline-block;
        min-width: 60px;
        font-family: monospace;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }
      button {
        padding: 8px 16px;
      }
      .status {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>AudioBufferSourceNode loopEnd Tester</h1>

    <div>
      <input type="file" id="audioFileInput" accept="audio/*" />
    </div>

    <div class="controls">
      <button id="playButton" disabled>Play</button>
      <button id="stopButton" disabled>Stop</button>
    </div>

    <div class="slider-container">
      <label for="loopEndSlider"
        >Loop End:
        <span id="loopEndValue" class="value-display">0.000</span> s</label
      >
      <input
        type="range"
        id="loopEndSlider"
        min="0.001"
        max="0.7"
        step="0.001"
        value="0.1"
      />
    </div>

    <div class="slider-container">
      <label for="rampTimeSlider"
        >Ramp Time:
        <span id="rampTimeValue" class="value-display">0.100</span> s</label
      >
      <input
        type="range"
        id="rampTimeSlider"
        min="0.01"
        max="2"
        step="0.01"
        value="0.1"
      />
    </div>

    <div class="status" id="statusDisplay">Ready to load audio file</div>

    <script>
      class PseudoAudioParam {
        constructor(targetObject, propertyName) {
          this.targetObject = targetObject; // Object containing the property
          this.propertyName = propertyName; // Property to control
          this.currentValue = targetObject[propertyName]; // Initial value
        }

        setValueAtTime(value, time) {
          const currentTime = this.targetObject.context.currentTime;
          const delay = Math.max(0, (time - currentTime) * 1000); // Convert time to milliseconds
          setTimeout(() => {
            this.targetObject[this.propertyName] = value;
            this.currentValue = value;
          }, delay);
        }

        linearRampToValueAtTime(value, endTime) {
          const startTime = this.targetObject.context.currentTime;
          const duration = Math.max(0, (endTime - startTime) * 1000); // Convert time to milliseconds
          const startValue = this.currentValue;
          const delta = value - startValue;

          const steps = Math.floor(duration / 10); // Number of interpolation steps
          let stepCount = 0;

          const intervalId = setInterval(() => {
            stepCount++;
            const progress = stepCount / steps;
            this.currentValue = startValue + delta * progress;
            this.targetObject[this.propertyName] = this.currentValue;

            if (stepCount >= steps) {
              clearInterval(intervalId);
              this.currentValue = value; // Ensure final value is set exactly
            }
          }, 2); // Todo: testing how low we can go (ms)
        }
      }

      // Audio setup
      let audioContext;
      let sourceNode;
      let audioBuffer;
      let pseudoLoopEnd;
      let isPlaying = false;

      // DOM elements
      const fileInput = document.getElementById('audioFileInput');
      const playButton = document.getElementById('playButton');
      const stopButton = document.getElementById('stopButton');
      const loopEndSlider = document.getElementById('loopEndSlider');
      const loopEndValue = document.getElementById('loopEndValue');
      const rampTimeSlider = document.getElementById('rampTimeSlider');
      const rampTimeValue = document.getElementById('rampTimeValue');
      const statusDisplay = document.getElementById('statusDisplay');

      // Initialize audio context on user interaction
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          log('Audio context initialized');
        }
      }

      // Load audio file
      fileInput.addEventListener('change', function (e) {
        initAudio();

        const file = e.target.files[0];
        if (!file) return;

        log(`Loading file: ${file.name}`);

        const reader = new FileReader();
        reader.onload = function (event) {
          audioContext
            .decodeAudioData(event.target.result)
            .then((buffer) => {
              audioBuffer = buffer;
              log(`File loaded. Duration: ${buffer.duration.toFixed(2)}s`);
              playButton.disabled = false;
            })
            .catch((err) => {
              log(`Error decoding audio: ${err.message}`);
            });
        };
        reader.onerror = function () {
          log('Error reading file');
        };
        reader.readAsArrayBuffer(file);
      });

      // Play audio
      playButton.addEventListener('click', function () {
        if (isPlaying) {
          stopAudio();
        }

        initAudio();

        if (!audioBuffer) {
          log('No audio loaded');
          return;
        }

        // Create source node
        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = audioBuffer;

        // Set up loop
        sourceNode.loop = true;
        sourceNode.loopStart = 0;
        sourceNode.loopEnd = parseFloat(loopEndSlider.value);

        // Create PseudoAudioParam for loopEnd
        pseudoLoopEnd = new PseudoAudioParam(sourceNode, 'loopEnd');

        // Connect to output
        sourceNode.connect(audioContext.destination);

        // Start playback
        sourceNode.start();
        isPlaying = true;
        playButton.textContent = 'Restart';
        stopButton.disabled = false;

        log(`Playing with initial loopEnd: ${sourceNode.loopEnd.toFixed(3)}s`);
      });

      // Stop audio
      stopButton.addEventListener('click', stopAudio);

      function stopAudio() {
        if (sourceNode && isPlaying) {
          sourceNode.stop();
          sourceNode = null;
          isPlaying = false;
          playButton.textContent = 'Play';
          stopButton.disabled = true;
          log('Playback stopped');
        }
      }

      // Update loopEnd value display
      loopEndSlider.addEventListener('input', function () {
        const value = parseFloat(this.value);
        loopEndValue.textContent = value.toFixed(3);

        if (sourceNode && isPlaying) {
          const currentTime = audioContext.currentTime;
          const rampTime = parseFloat(rampTimeSlider.value);

          pseudoLoopEnd.linearRampToValueAtTime(value, currentTime + rampTime);
          log(
            `Ramping loopEnd to ${value.toFixed(3)}s over ${rampTime.toFixed(2)}s`
          );
        }
      });

      // Update ramp time value display
      rampTimeSlider.addEventListener('input', function () {
        const value = parseFloat(this.value);
        rampTimeValue.textContent = value.toFixed(3);
      });

      // Helper for logging status
      function log(message) {
        console.log(message);
        statusDisplay.textContent += '\n' + message;
        statusDisplay.scrollTop = statusDisplay.scrollHeight;
      }
    </script>
  </body>
</html>
