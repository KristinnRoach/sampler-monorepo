<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Pitch Processor Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #1a1a1a;
        color: #ffffff;
      }

      .control-group {
        margin: 20px 0;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: 8px;
      }

      .control-group h3 {
        margin-top: 0;
        color: #4a9eff;
      }

      button {
        background-color: #4a9eff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #357abd;
      }

      button:disabled {
        background-color: #666;
        cursor: not-allowed;
      }

      input[type='range'] {
        width: 300px;
        margin: 10px;
      }

      input[type='file'] {
        margin: 10px;
        color: #ffffff;
      }

      .value-display {
        display: inline-block;
        min-width: 60px;
        padding: 5px 10px;
        background-color: #333;
        border-radius: 3px;
        margin-left: 10px;
      }

      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .status.error {
        background-color: #ff4444;
      }

      .status.success {
        background-color: #44ff44;
        color: black;
      }

      .midi-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
        gap: 5px;
        margin-top: 10px;
      }

      .midi-key {
        background-color: #555;
        border: 1px solid #777;
        padding: 8px 4px;
        text-align: center;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
      }

      .midi-key:hover {
        background-color: #666;
      }

      .midi-key.active {
        background-color: #4a9eff;
      }
    </style>
  </head>
  <body>
    <h1>Simple Pitch Processor Test</h1>

    <div class="control-group">
      <h3>Audio Input</h3>
      <button id="startMic">Start Microphone</button>
      <button id="stopMic" disabled>Stop Microphone</button>
      <br />
      <input type="file" id="audioFile" accept="audio/*" />
      <button id="playFile" disabled>Play File</button>
      <button id="stopFile" disabled>Stop File</button>
    </div>

    <div class="control-group">
      <h3>Pitch Control</h3>
      <label>
        Pitch Ratio:
        <input
          type="range"
          id="pitchSlider"
          min="0.25"
          max="4"
          step="0.01"
          value="1"
        />
        <span class="value-display" id="pitchValue">1.00</span>
      </label>
      <br />
      <button id="resetPitch">Reset (1.0)</button>

      <div class="midi-controls">
        <div class="midi-key" data-ratio="0.5">Oct-</div>
        <div class="midi-key" data-ratio="0.707">-5st</div>
        <div class="midi-key" data-ratio="0.841">-3st</div>
        <div class="midi-key" data-ratio="0.944">-1st</div>
        <div class="midi-key" data-ratio="1.0">0</div>
        <div class="midi-key" data-ratio="1.059">+1st</div>
        <div class="midi-key" data-ratio="1.189">+3st</div>
        <div class="midi-key" data-ratio="1.414">+5st</div>
        <div class="midi-key" data-ratio="2.0">Oct+</div>
      </div>
    </div>

    <div class="control-group">
      <h3>Effects</h3>
      <label>
        Dry/Wet Mix:
        <input
          type="range"
          id="mixSlider"
          min="0"
          max="1"
          step="0.01"
          value="1"
        />
        <span class="value-display" id="mixValue">1.00</span>
      </label>
      <br />
      <label>
        Output Gain:
        <input
          type="range"
          id="gainSlider"
          min="0"
          max="2"
          step="0.01"
          value="0.5"
        />
        <span class="value-display" id="gainValue">0.50</span>
      </label>
    </div>

    <div id="status"></div>

    <script>
      // AudioWorklet Processor Code
      const processorCode = `
        class SimplePitchProcessor extends AudioWorkletProcessor {
            constructor() {
                super();
                this.pitchRatio = 1.0;
                this.mix = 1.0;
                this.gain = 0.5;
                this.readIndex = 0;
                this.bufferSize = 8192;
                this.inputBuffer = new Float32Array(this.bufferSize);
                this.writeIndex = 0;
                
                this.port.onmessage = (event) => {
                    const { type, value } = event.data;
                    switch (type) {
                        case 'pitch':
                            this.pitchRatio = value;
                            break;
                        case 'mix':
                            this.mix = value;
                            break;
                        case 'gain':
                            this.gain = value;
                            break;
                    }
                };
            }
            
            interpolate(buffer, floatIndex) {
                const index = Math.floor(floatIndex);
                const fraction = floatIndex - index;
                
                if (index >= buffer.length - 1) {
                    return buffer[buffer.length - 1] || 0;
                }
                if (index < 0) {
                    return buffer[0] || 0;
                }
                
                const sample1 = buffer[index] || 0;
                const sample2 = buffer[index + 1] || 0;
                
                return sample1 + (sample2 - sample1) * fraction;
            }
            
            process(inputs, outputs, parameters) {
                const input = inputs[0];
                const output = outputs[0];
                
                if (!input || !input[0] || !output || !output[0]) {
                    return true;
                }
                
                const inputChannel = input[0];
                const outputChannel = output[0];
                const blockSize = outputChannel.length;
                
                // Fill input buffer
                for (let i = 0; i < blockSize; i++) {
                    this.inputBuffer[this.writeIndex] = inputChannel[i];
                    this.writeIndex = (this.writeIndex + 1) % this.bufferSize;
                }
                
                // Generate output with pitch shifting
                for (let i = 0; i < blockSize; i++) {
                    // Read from input buffer with pitch ratio
                    const readPos = this.readIndex;
                    const wetSample = this.interpolate(this.inputBuffer, readPos);
                    const drySample = inputChannel[i];
                    
                    // Mix dry and wet signals
                    const mixedSample = drySample * (1 - this.mix) + wetSample * this.mix;
                    outputChannel[i] = mixedSample * this.gain;
                    
                    // Advance read index by pitch ratio
                    this.readIndex += this.pitchRatio;
                    if (this.readIndex >= this.bufferSize) {
                        this.readIndex -= this.bufferSize;
                    }
                }
                
                return true;
            }
        }
        
        registerProcessor('simple-pitch-processor', SimplePitchProcessor);
        `;

      class PitchProcessorTest {
        constructor() {
          this.audioContext = null;
          this.workletNode = null;
          this.micStream = null;
          this.sourceNode = null;
          this.gainNode = null;
          this.audioElement = null;

          this.setupUI();
        }

        async init() {
          try {
            this.audioContext = new AudioContext();

            // Create and register the AudioWorklet
            const blob = new Blob([processorCode], {
              type: 'application/javascript',
            });
            const workletURL = URL.createObjectURL(blob);

            await this.audioContext.audioWorklet.addModule(workletURL);

            // Create worklet node
            this.workletNode = new AudioWorkletNode(
              this.audioContext,
              'simple-pitch-processor'
            );

            // Create gain node
            this.gainNode = this.audioContext.createGain();
            this.gainNode.gain.value = 0.5;

            // Connect: worklet -> gain -> destination
            this.workletNode.connect(this.gainNode);
            this.gainNode.connect(this.audioContext.destination);

            this.showStatus('AudioWorklet initialized successfully', 'success');

            URL.revokeObjectURL(workletURL);
          } catch (error) {
            this.showStatus('Failed to initialize: ' + error.message, 'error');
          }
        }

        setupUI() {
          // Pitch slider
          const pitchSlider = document.getElementById('pitchSlider');
          const pitchValue = document.getElementById('pitchValue');
          pitchSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            pitchValue.textContent = value.toFixed(2);
            this.setPitch(value);
          });

          // Mix slider
          const mixSlider = document.getElementById('mixSlider');
          const mixValue = document.getElementById('mixValue');
          mixSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            mixValue.textContent = value.toFixed(2);
            this.setMix(value);
          });

          // Gain slider
          const gainSlider = document.getElementById('gainSlider');
          const gainValue = document.getElementById('gainValue');
          gainSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            gainValue.textContent = value.toFixed(2);
            this.setGain(value);
          });

          // Buttons
          document
            .getElementById('startMic')
            .addEventListener('click', () => this.startMicrophone());
          document
            .getElementById('stopMic')
            .addEventListener('click', () => this.stopMicrophone());
          document
            .getElementById('playFile')
            .addEventListener('click', () => this.playFile());
          document
            .getElementById('stopFile')
            .addEventListener('click', () => this.stopFile());
          document
            .getElementById('resetPitch')
            .addEventListener('click', () => {
              pitchSlider.value = 1;
              pitchValue.textContent = '1.00';
              this.setPitch(1);
            });

          // File input
          document
            .getElementById('audioFile')
            .addEventListener('change', (e) => {
              this.loadAudioFile(e.target.files[0]);
            });

          // MIDI-style keys
          document.querySelectorAll('.midi-key').forEach((key) => {
            key.addEventListener('click', () => {
              const ratio = parseFloat(key.dataset.ratio);
              pitchSlider.value = ratio;
              pitchValue.textContent = ratio.toFixed(3);
              this.setPitch(ratio);

              // Visual feedback
              document
                .querySelectorAll('.midi-key')
                .forEach((k) => k.classList.remove('active'));
              key.classList.add('active');
              setTimeout(() => key.classList.remove('active'), 200);
            });
          });
        }

        async startMicrophone() {
          try {
            if (!this.audioContext) await this.init();

            this.micStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            this.sourceNode = this.audioContext.createMediaStreamSource(
              this.micStream
            );
            this.sourceNode.connect(this.workletNode);

            document.getElementById('startMic').disabled = true;
            document.getElementById('stopMic').disabled = false;

            this.showStatus('Microphone started', 'success');
          } catch (error) {
            this.showStatus('Microphone error: ' + error.message, 'error');
          }
        }

        stopMicrophone() {
          if (this.micStream) {
            this.micStream.getTracks().forEach((track) => track.stop());
            this.micStream = null;
          }
          if (this.sourceNode) {
            this.sourceNode.disconnect();
            this.sourceNode = null;
          }

          document.getElementById('startMic').disabled = false;
          document.getElementById('stopMic').disabled = true;

          this.showStatus('Microphone stopped', 'success');
        }

        async loadAudioFile(file) {
          if (!file) return;

          try {
            if (!this.audioContext) await this.init();

            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer =
              await this.audioContext.decodeAudioData(arrayBuffer);

            // Create audio element for playback control
            this.audioElement = new Audio();
            this.audioElement.src = URL.createObjectURL(file);
            this.audioElement.loop = true;

            // Create media element source
            if (this.sourceNode) {
              this.sourceNode.disconnect();
            }
            this.sourceNode = this.audioContext.createMediaElementSource(
              this.audioElement
            );
            this.sourceNode.connect(this.workletNode);

            document.getElementById('playFile').disabled = false;
            this.showStatus('Audio file loaded: ' + file.name, 'success');
          } catch (error) {
            this.showStatus('File load error: ' + error.message, 'error');
          }
        }

        playFile() {
          if (this.audioElement) {
            this.audioElement.play();
            document.getElementById('playFile').disabled = true;
            document.getElementById('stopFile').disabled = false;
            this.showStatus('Playing file', 'success');
          }
        }

        stopFile() {
          if (this.audioElement) {
            this.audioElement.pause();
            this.audioElement.currentTime = 0;
            document.getElementById('playFile').disabled = false;
            document.getElementById('stopFile').disabled = true;
            this.showStatus('File stopped', 'success');
          }
        }

        setPitch(value) {
          if (this.workletNode) {
            this.workletNode.port.postMessage({ type: 'pitch', value });
          }
        }

        setMix(value) {
          if (this.workletNode) {
            this.workletNode.port.postMessage({ type: 'mix', value });
          }
        }

        setGain(value) {
          if (this.workletNode) {
            this.workletNode.port.postMessage({ type: 'gain', value });
          }
        }

        showStatus(message, type = '') {
          const statusEl = document.getElementById('status');
          statusEl.textContent = message;
          statusEl.className = 'status ' + type;
        }
      }

      // Initialize the test application
      const pitchTest = new PitchProcessorTest();

      // Auto-initialize on first user interaction
      document.addEventListener(
        'click',
        async () => {
          if (!pitchTest.audioContext) {
            await pitchTest.init();
          }
        },
        { once: true }
      );
    </script>
  </body>
</html>
