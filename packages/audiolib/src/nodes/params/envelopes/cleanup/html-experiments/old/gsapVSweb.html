<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Audio API vs GSAP Timing Comparison</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .controls {
        display: flex;
        gap: 20px;
        align-items: center;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      label {
        font-weight: bold;
        color: #555;
      }

      input,
      select,
      button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background: #007acc;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
        min-width: 140px;
      }

      button:hover {
        background: #005a9e;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .experiment {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 6px;
        margin: 20px 0;
        border-left: 4px solid #007acc;
      }

      .status {
        font-weight: bold;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        text-align: center;
      }

      .status.playing {
        background: #d4edda;
        color: #155724;
      }

      .status.stopped {
        background: #f8d7da;
        color: #721c24;
      }

      .comparison {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 20px;
        border-radius: 4px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Web Audio API vs GSAP Timing Experiment</h1>

      <div class="experiment">
        <h3>üéØ Experiment Goal</h3>
        <p>
          Compare timing precision between Web Audio API's
          <code>setValueCurveAtTime</code> (audio thread) and GSAP animation
          (main thread).
        </p>
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="curveType">Curve Type</label>
          <select id="curveType">
            <option value="linear">Linear Sweep</option>
            <option value="exponential">Exponential</option>
            <option value="sine">Sine Wave</option>
          </select>
        </div>

        <div class="control-group">
          <label for="duration">Duration</label>
          <input
            type="range"
            id="duration"
            min="1"
            max="4"
            value="2"
            step="0.5"
          />
          <span id="durationValue">2.0s</span>
        </div>
      </div>

      <div class="controls">
        <button id="playWebAudioBtn">üéµ Web Audio API</button>
        <button id="playGsapBtn">üé® GSAP Animation</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>

      <div id="status" class="status stopped">Ready to compare</div>

      <div class="comparison">
        <strong>Listen for the difference:</strong><br />
        ‚Ä¢ <strong>Web Audio API:</strong> Precise timing, scheduled on audio
        thread<br />
        ‚Ä¢ <strong>GSAP:</strong> ~60fps updates from main thread, may have
        slight irregularities<br />
        ‚Ä¢ Try opening dev tools or creating CPU load while GSAP plays to hear
        the difference
      </div>
    </div>

    <script>
      class TimingComparison {
        constructor() {
          this.audioContext = null;
          this.oscillator = null;
          this.gainNode = null;
          this.gsapTween = null;
          this.isPlaying = false;

          setTimeout(() => {
            this.setupEventListeners();
          }, 0);
        }

        async initAudio() {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }

          if (this.audioContext.state === 'suspended') {
            await this.audioContext.resume();
          }
        }

        setupEventListeners() {
          document
            .getElementById('playWebAudioBtn')
            .addEventListener('click', () => this.playWebAudio());
          document
            .getElementById('playGsapBtn')
            .addEventListener('click', () => this.playGsap());
          document
            .getElementById('stopBtn')
            .addEventListener('click', () => this.stop());

          document.getElementById('duration').addEventListener('input', (e) => {
            document.getElementById('durationValue').textContent =
              e.target.value + 's';
          });
        }

        generateCurve() {
          const curveType = document.getElementById('curveType').value;
          const baseFreq = 440;
          const numPoints = 200;
          const curve = new Float32Array(numPoints);

          for (let i = 0; i < numPoints; i++) {
            const t = i / (numPoints - 1);

            switch (curveType) {
              case 'linear':
                curve[i] = baseFreq + baseFreq * t;
                break;
              case 'exponential':
                curve[i] = baseFreq * Math.pow(2, t * 2);
                break;
              case 'sine':
                curve[i] =
                  baseFreq + baseFreq * 0.5 * Math.sin(t * Math.PI * 4);
                break;
            }
          }

          return curve;
        }

        async playWebAudio() {
          try {
            await this.initAudio();
            this.stop();

            this.oscillator = this.audioContext.createOscillator();
            this.gainNode = this.audioContext.createGain();

            this.oscillator.connect(this.gainNode);
            this.gainNode.connect(this.audioContext.destination);

            const duration = parseFloat(
              document.getElementById('duration').value
            );
            const curve = this.generateCurve();

            this.oscillator.frequency.value = 440;
            this.gainNode.gain.value = 0.2;

            const startTime = this.audioContext.currentTime + 0.01;
            this.oscillator.frequency.setValueCurveAtTime(
              curve,
              startTime,
              duration
            );

            this.oscillator.start(startTime);
            this.oscillator.stop(startTime + duration + 0.1);

            this.updateUI('Web Audio API', duration);

            setTimeout(() => this.stop(), (duration + 0.1) * 1000);
          } catch (error) {
            console.error('Web Audio error:', error);
          }
        }

        async playGsap() {
          try {
            await this.initAudio();
            this.stop();

            this.oscillator = this.audioContext.createOscillator();
            this.gainNode = this.audioContext.createGain();

            this.oscillator.connect(this.gainNode);
            this.gainNode.connect(this.audioContext.destination);

            const duration = parseFloat(
              document.getElementById('duration').value
            );
            const curveType = document.getElementById('curveType').value;

            this.oscillator.frequency.value = 440;
            this.gainNode.gain.value = 0.2;

            const startTime = this.audioContext.currentTime + 0.01;
            this.oscillator.start(startTime);

            const syncDelay = Math.max(
              0,
              (startTime - this.audioContext.currentTime) * 1000
            );

            // Generate the same curve data that Web Audio uses
            const curve = this.generateCurve();
            const freqObj = { value: 440 };

            // Create a timeline that steps through the curve array
            this.gsapTween = gsap.timeline();

            // Sample the curve at regular intervals (matching ~60fps)
            const sampleRate = 60; // fps
            const totalSamples = Math.floor(duration * sampleRate);

            this.gsapTween.set(freqObj, { value: curve[0] }, syncDelay / 1000);

            for (let i = 1; i <= totalSamples; i++) {
              const progress = i / totalSamples;
              const curveIndex = Math.floor(progress * (curve.length - 1));
              const targetValue = curve[curveIndex];
              const timeOffset = syncDelay / 1000 + progress * duration;

              this.gsapTween.set(
                freqObj,
                {
                  value: targetValue,
                  onUpdate: () => {
                    if (this.oscillator && this.oscillator.frequency) {
                      this.oscillator.frequency.value = freqObj.value;
                    }
                  },
                },
                timeOffset
              );
            }

            this.gsapTween.call(
              () => this.stop(),
              [],
              syncDelay / 1000 + duration
            );

            this.updateUI('GSAP', duration);
          } catch (error) {
            console.error('GSAP error:', error);
          }
        }

        getGsapEase(curveType) {
          switch (curveType) {
            case 'linear':
              return 'none';
            case 'exponential':
              return 'power2.out';
            case 'sine':
              return 'sine.inOut';
            default:
              return 'none';
          }
        }

        updateUI(method, duration) {
          this.isPlaying = true;
          document.getElementById('playWebAudioBtn').disabled = true;
          document.getElementById('playGsapBtn').disabled = true;
          document.getElementById('stopBtn').disabled = false;
          document.getElementById('status').textContent =
            `Playing ${method} for ${duration}s`;
          document.getElementById('status').className = 'status playing';
        }

        stop() {
          if (this.gsapTween) {
            this.gsapTween.kill();
            this.gsapTween = null;
          }

          if (this.oscillator) {
            try {
              this.oscillator.stop();
            } catch (e) {
              // Already stopped
            }
            this.oscillator = null;
          }

          this.isPlaying = false;
          document.getElementById('playWebAudioBtn').disabled = false;
          document.getElementById('playGsapBtn').disabled = false;
          document.getElementById('stopBtn').disabled = true;
          document.getElementById('status').textContent = 'Ready to compare';
          document.getElementById('status').className = 'status stopped';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        new TimingComparison();
      });
    </script>
  </body>
</html>
