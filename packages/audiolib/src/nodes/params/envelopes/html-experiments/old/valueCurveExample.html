<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AudioParam.setValueCurveAtTime() Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .section {
        margin: 25px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 6px;
        border-left: 4px solid #007acc;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }

      input,
      select,
      button {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        background: #007acc;
        color: white;
        border: none;
        cursor: pointer;
        padding: 12px 20px;
        font-weight: bold;
        margin: 10px 5px;
        transition: background 0.2s;
      }

      button:hover {
        background: #005a9e;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }

      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }

      canvas {
        border: 1px solid #ddd;
        background: white;
        width: 100%;
        height: 200px;
        margin: 10px 0;
      }

      .curve-display {
        margin: 20px 0;
      }

      .status {
        font-weight: bold;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .status.playing {
        background: #d4edda;
        color: #155724;
      }

      .status.stopped {
        background: #f8d7da;
        color: #721c24;
      }

      code {
        background: #f1f1f1;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
      }

      .example-curves {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }

      .curve-button {
        padding: 10px;
        background: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        transition: background 0.2s;
      }

      .curve-button:hover {
        background: #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AudioParam.setValueCurveAtTime() Interactive Demo</h1>

      <div class="info">
        <strong>What is setValueCurveAtTime?</strong><br />
        This method schedules an array of values to be applied to an AudioParam
        over a specified time period, creating smooth transitions between
        values.
      </div>

      <div class="section">
        <h3>üéõÔ∏è Controls</h3>
        <div class="controls">
          <div class="control-group">
            <label for="frequency">Base Frequency (Hz)</label>
            <input
              type="range"
              id="frequency"
              min="100"
              max="1000"
              value="440"
              step="10"
            />
            <span id="freqValue">440 Hz</span>
          </div>

          <div class="control-group">
            <label for="duration">Curve Duration (seconds)</label>
            <input
              type="range"
              id="duration"
              min="0.5"
              max="5"
              value="2"
              step="0.1"
            />
            <span id="durationValue">2.0s</span>
          </div>

          <div class="control-group">
            <label for="curveType">Curve Type</label>
            <select id="curveType">
              <option value="linear">Linear Sweep</option>
              <option value="exponential">Exponential</option>
              <option value="sine">Sine Wave</option>
              <option value="sawtooth">Sawtooth</option>
              <option value="custom">Custom Curve</option>
            </select>
          </div>
        </div>

        <div class="controls">
          <button id="playBtn">‚ñ∂Ô∏è Play Curve</button>
          <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
          <button id="clearBtn">üßπ Clear Schedule</button>
        </div>

        <div id="status" class="status stopped">Ready to play</div>
      </div>

      <div class="section">
        <h3>üìä Curve Visualization</h3>
        <canvas id="curveCanvas"></canvas>
        <div class="curve-display">
          <strong>Current curve values:</strong>
          <span id="curveValues">[Not generated yet]</span>
        </div>
      </div>

      <div class="section">
        <h3>üéØ Quick Examples</h3>
        <div class="example-curves">
          <div class="curve-button" data-curve="pitch-bend">Pitch Bend</div>
          <div class="curve-button" data-curve="tremolo">Tremolo Effect</div>
          <div class="curve-button" data-curve="glide">Frequency Glide</div>
          <div class="curve-button" data-curve="wobble">Wobble Bass</div>
        </div>
      </div>

      <div class="warning">
        <strong>‚ö†Ô∏è Important Caveats:</strong><br />
        ‚Ä¢ The curve array length determines resolution - more values = smoother
        curve<br />
        ‚Ä¢ Values are linearly interpolated between array points<br />
        ‚Ä¢ <code>setValueCurveAtTime</code> cancels any previously scheduled
        changes<br />
        ‚Ä¢ Duration must be positive and greater than 0<br />
        ‚Ä¢ Start time should be ‚â• audioContext.currentTime<br />
        ‚Ä¢ Curve values should be within the AudioParam's valid range
      </div>

      <div class="info">
        <strong>üí° Tips:</strong><br />
        ‚Ä¢ Use more array values for smoother curves (typically 100-1000
        values)<br />
        ‚Ä¢ For pitch modulation, use frequency multipliers rather than absolute
        values<br />
        ‚Ä¢ Chain multiple <code>setValueCurveAtTime</code> calls for complex
        sequences<br />
        ‚Ä¢ Consider using <code>cancelScheduledValues</code> before applying new
        curves
      </div>
    </div>

    <script>
      class AudioParamDemo {
        constructor() {
          this.audioContext = null;
          this.oscillator = null;
          this.gainNode = null;
          this.isPlaying = false;
          this.canvas = null;
          this.ctx = null;

          // Use setTimeout to ensure DOM elements are available
          setTimeout(() => {
            this.setupEventListeners();
            this.setupCanvas();
            this.updateVisualization();
          }, 0);
        }

        async initAudio() {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }

          if (this.audioContext.state === 'suspended') {
            await this.audioContext.resume();
          }
        }

        setupEventListeners() {
          document
            .getElementById('playBtn')
            .addEventListener('click', () => this.playCurve());
          document
            .getElementById('stopBtn')
            .addEventListener('click', () => this.stopAudio());
          document
            .getElementById('clearBtn')
            .addEventListener('click', () => this.clearSchedule());

          document
            .getElementById('frequency')
            .addEventListener('input', (e) => {
              document.getElementById('freqValue').textContent =
                e.target.value + ' Hz';
              this.updateVisualization();
            });

          document.getElementById('duration').addEventListener('input', (e) => {
            document.getElementById('durationValue').textContent =
              e.target.value + 's';
            this.updateVisualization();
          });

          document
            .getElementById('curveType')
            .addEventListener('change', () => {
              this.updateVisualization();
            });

          // Quick example buttons
          document.querySelectorAll('.curve-button').forEach((btn) => {
            btn.addEventListener('click', (e) => {
              this.loadExample(e.target.dataset.curve);
            });
          });
        }

        setupCanvas() {
          this.canvas = document.getElementById('curveCanvas');
          if (!this.canvas) {
            console.error('Canvas element not found');
            return;
          }
          this.ctx = this.canvas.getContext('2d');

          // Set fixed canvas size to avoid timing issues
          this.canvas.width = 800;
          this.canvas.height = 200;
        }

        generateCurve() {
          const curveType = document.getElementById('curveType').value;
          const baseFreq = parseFloat(
            document.getElementById('frequency').value
          );
          const duration = parseFloat(
            document.getElementById('duration').value
          );

          // Generate 200 points for smooth curve
          const numPoints = 200;
          const curve = new Float32Array(numPoints);

          for (let i = 0; i < numPoints; i++) {
            const t = i / (numPoints - 1); // 0 to 1

            switch (curveType) {
              case 'linear':
                curve[i] = baseFreq + baseFreq * t; // Linear sweep up
                break;
              case 'exponential':
                curve[i] = baseFreq * Math.pow(2, t * 2); // Exponential curve
                break;
              case 'sine':
                curve[i] =
                  baseFreq + baseFreq * 0.5 * Math.sin(t * Math.PI * 4); // Sine modulation
                break;
              case 'sawtooth':
                curve[i] = baseFreq + baseFreq * (((t * 4) % 1) - 0.5); // Sawtooth
                break;
              case 'custom':
                // Custom curve: exponential decay with oscillation
                curve[i] =
                  baseFreq +
                  baseFreq * Math.exp(-t * 3) * Math.sin(t * Math.PI * 6);
                break;
            }
          }

          return curve;
        }

        updateVisualization() {
          const curve = this.generateCurve();
          this.drawCurve(curve);

          // Display first few values
          const displayValues = Array.from(curve.slice(0, 8))
            .map((v) => Math.round(v))
            .join(', ');
          document.getElementById('curveValues').textContent =
            `[${displayValues}...] (${curve.length} total points)`;
        }

        drawCurve(curve) {
          if (!this.canvas || !this.ctx) {
            console.error('Canvas not initialized');
            return;
          }

          const ctx = this.ctx;
          const width = this.canvas.width;
          const height = this.canvas.height;

          // Clear canvas
          ctx.clearRect(0, 0, width, height);

          // Draw grid
          ctx.strokeStyle = '#e0e0e0';
          ctx.lineWidth = 1;

          // Horizontal lines
          for (let i = 0; i <= 4; i++) {
            const y = (height / 4) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
          }

          // Vertical lines
          for (let i = 0; i <= 4; i++) {
            const x = (width / 4) * i;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
          }

          // Find min/max for scaling
          const minVal = Math.min(...curve);
          const maxVal = Math.max(...curve);
          const range = maxVal - minVal;

          // Draw curve
          ctx.strokeStyle = '#007acc';
          ctx.lineWidth = 2;
          ctx.beginPath();

          for (let i = 0; i < curve.length; i++) {
            const x = (i / (curve.length - 1)) * width;
            const normalizedY = (curve[i] - minVal) / range;
            const y = height - (normalizedY * height * 0.8 + height * 0.1);

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }

          ctx.stroke();

          // Draw labels
          ctx.fillStyle = '#333';
          ctx.font = '12px Arial';
          ctx.fillText(`${Math.round(minVal)} Hz`, 5, height - 5);
          ctx.fillText(`${Math.round(maxVal)} Hz`, 5, 15);
          ctx.fillText('0s', 5, height / 2);
          ctx.fillText(
            `${document.getElementById('duration').value}s`,
            width - 30,
            height / 2
          );
        }

        async playCurve() {
          try {
            await this.initAudio();

            // Stop any existing audio
            this.stopAudio();

            // Create oscillator and gain
            this.oscillator = this.audioContext.createOscillator();
            this.gainNode = this.audioContext.createGain();

            // Connect audio graph
            this.oscillator.connect(this.gainNode);
            this.gainNode.connect(this.audioContext.destination);

            // Set initial values
            const baseFreq = parseFloat(
              document.getElementById('frequency').value
            );
            const duration = parseFloat(
              document.getElementById('duration').value
            );

            this.oscillator.frequency.value = baseFreq;
            this.gainNode.gain.value = 0.3; // Moderate volume

            // Generate and apply curve
            const curve = this.generateCurve();
            const startTime = this.audioContext.currentTime;

            // Clear any existing scheduled values
            this.oscillator.frequency.cancelScheduledValues(startTime);

            // Apply the curve
            this.oscillator.frequency.setValueCurveAtTime(
              curve,
              startTime,
              duration
            );

            // Start oscillator
            this.oscillator.start(startTime);
            this.oscillator.stop(startTime + duration + 0.1);

            // Update UI
            this.isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').textContent =
              `Playing curve for ${duration}s`;
            document.getElementById('status').className = 'status playing';

            // Auto-stop after duration
            setTimeout(
              () => {
                this.stopAudio();
              },
              (duration + 0.1) * 1000
            );
          } catch (error) {
            console.error('Audio error:', error);
            alert('Audio error: ' + error.message);
          }
        }

        stopAudio() {
          if (this.oscillator) {
            try {
              this.oscillator.stop();
            } catch (e) {
              // Oscillator might already be stopped
            }
            this.oscillator = null;
          }

          this.isPlaying = false;
          document.getElementById('playBtn').disabled = false;
          document.getElementById('stopBtn').disabled = true;
          document.getElementById('status').textContent = 'Stopped';
          document.getElementById('status').className = 'status stopped';
        }

        clearSchedule() {
          if (this.oscillator && this.oscillator.frequency) {
            this.oscillator.frequency.cancelScheduledValues(
              this.audioContext.currentTime
            );
          }
          document.getElementById('status').textContent = 'Schedule cleared';
          document.getElementById('status').className = 'status stopped';
        }

        loadExample(exampleType) {
          const freqSlider = document.getElementById('frequency');
          const durationSlider = document.getElementById('duration');
          const curveSelect = document.getElementById('curveType');

          switch (exampleType) {
            case 'pitch-bend':
              freqSlider.value = 440;
              durationSlider.value = 1.5;
              curveSelect.value = 'exponential';
              break;
            case 'tremolo':
              freqSlider.value = 220;
              durationSlider.value = 3;
              curveSelect.value = 'sine';
              break;
            case 'glide':
              freqSlider.value = 880;
              durationSlider.value = 2.5;
              curveSelect.value = 'linear';
              break;
            case 'wobble':
              freqSlider.value = 100;
              durationSlider.value = 4;
              curveSelect.value = 'sawtooth';
              break;
          }

          // Update displays
          document.getElementById('freqValue').textContent =
            freqSlider.value + ' Hz';
          document.getElementById('durationValue').textContent =
            durationSlider.value + 's';

          this.updateVisualization();
        }
      }

      // Initialize the demo when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        new AudioParamDemo();
      });
    </script>
  </body>
</html>
