<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loop Interpolation Demo</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 20px;
        max-width: 100vw;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      h1 {
        margin-bottom: 5px;
      }
      .controller {
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 10px;
        background-color: #f9f9f9;
      }
      .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background-color: #4caf50;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      .btn:hover {
        background-color: #45a049;
      }
      .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .sliders {
        display: flex;
        flex-direction: column;
        gap: 30px;
        width: 100%;
        position: relative;
      }
      .slider-container {
        width: 100%;
        position: relative;
      }
      .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .slider {
        width: 100%;
        height: 30px;
      }
      .info {
        margin-top: 10px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>Loop Interpolation Demo</h1>
    <div id="status">Loading audio...</div>

    <!-- WorkletNode Implementation -->
    <div class="controller">
      <h2>1. AudioWorkletNode Implementation</h2>
      <div class="controls">
        <button id="worklet-play" class="btn" disabled>Play</button>
        <button id="worklet-stop" class="btn" disabled>Stop</button>
        <div>
          <label for="worklet-speed">Interpolation Speed:</label>
          <input
            type="range"
            id="worklet-speed"
            min="0.001"
            max="0.2"
            step="0.001"
            value="0.05"
          />
          <span id="worklet-speed-value">0.05</span>
        </div>
      </div>
      <div class="sliders">
        <div class="slider-container">
          <div class="slider-label">
            <label for="worklet-start">Loop Start:</label>
            <span id="worklet-start-value">0.00</span>s
          </div>
          <input
            type="range"
            id="worklet-start"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="0"
          />
        </div>
        <div class="slider-container">
          <div class="slider-label">
            <label for="worklet-end">Loop End:</label>
            <span id="worklet-end-value">1.00</span>s
          </div>
          <input
            type="range"
            id="worklet-end"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="1"
          />
        </div>
      </div>
      <div class="info" id="worklet-info"></div>
    </div>

    <!-- RequestAnimationFrame Implementation -->
    <div class="controller">
      <h2>2. RequestAnimationFrame Implementation</h2>
      <div class="controls">
        <button id="raf-play" class="btn" disabled>Play</button>
        <button id="raf-stop" class="btn" disabled>Stop</button>
        <div>
          <label for="raf-speed">Interpolation Speed:</label>
          <input
            type="range"
            id="raf-speed"
            min="0.001"
            max="0.2"
            step="0.001"
            value="0.05"
          />
          <span id="raf-speed-value">0.05</span>
        </div>
      </div>
      <div class="sliders">
        <div class="slider-container">
          <div class="slider-label">
            <label for="raf-start">Loop Start:</label>
            <span id="raf-start-value">0.00</span>s
          </div>
          <input
            type="range"
            id="raf-start"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="0"
          />
        </div>
        <div class="slider-container">
          <div class="slider-label">
            <label for="raf-end">Loop End:</label>
            <span id="raf-end-value">1.00</span>s
          </div>
          <input
            type="range"
            id="raf-end"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="1"
          />
        </div>
      </div>
      <div class="info" id="raf-info"></div>
    </div>

    <script>
      // Global variables
      let audioCtx;
      let buffer;
      let minLoopDuration = 0.0005; // ~4ms, approx C4 period (261.63 Hz -> ~3.82ms)
      const statusElement = document.getElementById('status');

      // Worklet variables
      let workletNode;
      const workletPlayBtn = document.getElementById('worklet-play');
      const workletStopBtn = document.getElementById('worklet-stop');
      const workletStartSlider = document.getElementById('worklet-start');
      const workletEndSlider = document.getElementById('worklet-end');
      const workletStartValue = document.getElementById('worklet-start-value');
      const workletEndValue = document.getElementById('worklet-end-value');
      const workletSpeedSlider = document.getElementById('worklet-speed');
      const workletSpeedValue = document.getElementById('worklet-speed-value');
      const workletInfo = document.getElementById('worklet-info');

      // RAF variables
      let rafSource;
      let rafIsPlaying = false;
      let rafCurrentLoopStart = 0;
      let rafCurrentLoopEnd = 1;
      let rafTargetLoopStart = 0;
      let rafTargetLoopEnd = 1;
      let rafInterpolationSpeed = 0.05;

      const rafPlayBtn = document.getElementById('raf-play');
      const rafStopBtn = document.getElementById('raf-stop');
      const rafStartSlider = document.getElementById('raf-start');
      const rafEndSlider = document.getElementById('raf-end');
      const rafStartValue = document.getElementById('raf-start-value');
      const rafEndValue = document.getElementById('raf-end-value');
      const rafSpeedSlider = document.getElementById('raf-speed');
      const rafSpeedValue = document.getElementById('raf-speed-value');
      const rafInfo = document.getElementById('raf-info');

      // Initialize audio
      async function initAudio() {
        try {
          statusElement.textContent = 'Initializing audio context...';

          audioCtx = new AudioContext();

          // Load audio file
          statusElement.textContent = 'Loading audio file...';
          const response = await fetch('piano-c4.mp3');
          buffer = await audioCtx.decodeAudioData(await response.arrayBuffer());

          // Update UI with buffer duration
          const duration = buffer.duration;

          workletStartSlider.max = duration;
          workletEndSlider.max = duration;
          workletEndSlider.value = duration;
          workletEndValue.textContent = duration.toFixed(2);

          rafStartSlider.max = duration;
          rafEndSlider.max = duration;
          rafEndSlider.value = duration;
          rafEndValue.textContent = duration.toFixed(2);

          // Enable buttons
          workletPlayBtn.disabled = false;
          rafPlayBtn.disabled = false;

          statusElement.textContent = `Audio loaded: ${duration.toFixed(2)}s duration`;

          // Initialize worklet
          try {
            statusElement.textContent = 'Loading AudioWorklet...';
            await audioCtx.audioWorklet.addModule(
              'loop-interpolator-processor.js'
            );
            statusElement.textContent = 'Ready to play!';
          } catch (err) {
            console.error('Error loading worklet:', err);
            workletInfo.innerHTML = `<strong>Error:</strong> Could not load AudioWorklet: ${err.message}<br>
            Make sure you have the file "loop-interpolator-processor.js" in the same directory.`;
            workletInfo.style.color = 'red';
            statusElement.textContent =
              'AudioWorklet failed to load. RAF implementation still available.';
          }
        } catch (err) {
          console.error('Error initializing audio:', err);
          statusElement.textContent = `Error: ${err.message}`;
          statusElement.style.color = 'red';
        }
      }

      // --- WORKLET IMPLEMENTATION ---

      function setupWorkletNode() {
        // Create and configure worklet node
        workletNode = new AudioWorkletNode(audioCtx, 'loop-interpolator');
        workletNode.connect(audioCtx.destination);

        // Set initial parameters
        const startValue = parseFloat(workletStartSlider.value);
        const endValue = parseFloat(workletEndSlider.value);
        const speedValue = parseFloat(workletSpeedSlider.value);

        workletNode.parameters.get('targetLoopStart').value = startValue;
        workletNode.parameters.get('targetLoopEnd').value = endValue;
        workletNode.parameters.get('interpolationSpeed').value = speedValue;

        // Send buffer data to worklet - extract channel data first
        const channelData = [];
        for (let i = 0; i < buffer.numberOfChannels; i++) {
          channelData.push(buffer.getChannelData(i).slice());
        }

        workletNode.port.postMessage({
          type: 'setBuffer',
          buffer: channelData,
          sampleRate: buffer.sampleRate,
        });

        return workletNode;
      }

      function startWorklet() {
        if (!audioCtx) return;

        // Resume audio context if needed
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // Setup worklet if not already created
        if (!workletNode) {
          try {
            workletNode = setupWorkletNode();
          } catch (err) {
            console.error('Error setting up worklet:', err);
            workletInfo.innerHTML = `<strong>Error:</strong> ${err.message}`;
            workletInfo.style.color = 'red';
            return;
          }
        }

        // Start playback
        workletNode.port.postMessage({ type: 'play' });

        // Update UI
        workletPlayBtn.disabled = true;
        workletStopBtn.disabled = false;
      }

      function stopWorklet() {
        if (!workletNode) return;

        // Stop playback
        workletNode.port.postMessage({ type: 'stop' });

        // Update UI
        workletPlayBtn.disabled = false;
        workletStopBtn.disabled = true;
      }

      function updateWorkletLoopPoints() {
        if (!workletNode) return;

        let startValue = parseFloat(workletStartSlider.value);
        let endValue = parseFloat(workletEndSlider.value);

        dynamicUpdateWorkletSpeed(endValue, startValue);

        // Enforce minimum loop duration
        if (endValue - startValue < minLoopDuration) {
          if (this === workletStartSlider) {
            startValue = endValue - minLoopDuration;
            workletStartSlider.value = startValue;
          } else if (this === workletEndSlider) {
            endValue = startValue + minLoopDuration;
            workletEndSlider.value = endValue;
          }
        }

        // Update parameters
        workletNode.parameters.get('targetLoopStart').value = startValue;
        workletNode.parameters.get('targetLoopEnd').value = endValue;

        // Update display values
        workletStartValue.textContent = startValue.toFixed(3);
        workletEndValue.textContent = endValue.toFixed(3);
        workletInfo.textContent = `Loop duration: ${(endValue - startValue).toFixed(3)}s`;
      }

      function dynamicUpdateWorkletSpeed(endValue, startValue) {
        const loopDuration = endValue - startValue;

        // Scale speed inversely to loop duration with constraints
        // Small loops → faster interpolation, large loops → slower interpolation
        const scaledSpeed = Math.min(
          0.15,
          Math.max(0.005, 0.05 / loopDuration)
        );

        workletSpeedValue.textContent = scaledSpeed.toFixed(3);

        if (workletNode) {
          workletNode.parameters.get('interpolationSpeed').value = scaledSpeed;
        }
      }

      function updateWorkletSpeed() {
        const speedValue = parseFloat(workletSpeedSlider.value);
        workletSpeedValue.textContent = speedValue.toFixed(3);

        if (workletNode) {
          workletNode.parameters.get('interpolationSpeed').value = speedValue;
        }
      }

      // --- RAF IMPLEMENTATION ---

      function startRAF() {
        if (!audioCtx) return;

        // Resume audio context if needed
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // Stop existing source if playing
        if (rafIsPlaying && rafSource) {
          rafSource.stop();
        }

        // Create new source
        rafSource = audioCtx.createBufferSource();
        rafSource.buffer = buffer;
        rafSource.loop = true;
        rafSource.connect(audioCtx.destination);

        // Get current values
        rafTargetLoopStart = parseFloat(rafStartSlider.value);
        rafTargetLoopEnd = parseFloat(rafEndSlider.value);
        rafCurrentLoopStart = rafTargetLoopStart;
        rafCurrentLoopEnd = rafTargetLoopEnd;
        rafInterpolationSpeed = parseFloat(rafSpeedSlider.value);

        // Set initial loop points
        rafSource.loopStart = rafCurrentLoopStart;
        rafSource.loopEnd = rafCurrentLoopEnd;

        // Start playback
        rafSource.start();
        rafIsPlaying = true;

        // Start animation frame loop
        requestAnimationFrame(updateRAFLoop);

        // Update UI
        rafPlayBtn.disabled = true;
        rafStopBtn.disabled = false;
      }

      function stopRAF() {
        if (!rafIsPlaying) return;

        // Stop source
        if (rafSource) {
          rafSource.stop();
        }

        rafIsPlaying = false;

        // Update UI
        rafPlayBtn.disabled = false;
        rafStopBtn.disabled = true;
      }

      function updateRAFLoop() {
        if (!rafIsPlaying) return;

        // Interpolate values
        rafCurrentLoopStart +=
          (rafTargetLoopStart - rafCurrentLoopStart) * rafInterpolationSpeed;
        rafCurrentLoopEnd +=
          (rafTargetLoopEnd - rafCurrentLoopEnd) * rafInterpolationSpeed;

        // Apply to source
        if (rafSource) {
          rafSource.loopStart = rafCurrentLoopStart;
          rafSource.loopEnd = rafCurrentLoopEnd;
        }

        // Update info
        rafInfo.textContent = `Current loop: ${rafCurrentLoopStart.toFixed(3)}s - ${rafCurrentLoopEnd.toFixed(3)}s (${(rafCurrentLoopEnd - rafCurrentLoopStart).toFixed(3)}s duration)`;

        // Continue loop
        requestAnimationFrame(updateRAFLoop);
      }

      function updateRAFLoopPoints() {
        let startValue = parseFloat(rafStartSlider.value);
        let endValue = parseFloat(rafEndSlider.value);

        // Enforce minimum loop duration
        if (endValue - startValue < minLoopDuration) {
          if (this === rafStartSlider) {
            startValue = endValue - minLoopDuration;
            rafStartSlider.value = startValue;
          } else if (this === rafEndSlider) {
            endValue = startValue + minLoopDuration;
            rafEndSlider.value = endValue;
          }
        }

        // Update target values
        rafTargetLoopStart = startValue;
        rafTargetLoopEnd = endValue;

        // Update display values
        rafStartValue.textContent = startValue.toFixed(3);
        rafEndValue.textContent = endValue.toFixed(3);
      }

      function updateRAFSpeed() {
        rafInterpolationSpeed = parseFloat(rafSpeedSlider.value);
        rafSpeedValue.textContent = rafInterpolationSpeed.toFixed(3);
      }

      // --- EVENT LISTENERS ---

      // Worklet controls
      workletPlayBtn.addEventListener('click', startWorklet);
      workletStopBtn.addEventListener('click', stopWorklet);
      workletStartSlider.addEventListener('input', updateWorkletLoopPoints);
      workletEndSlider.addEventListener('input', updateWorkletLoopPoints);
      workletSpeedSlider.addEventListener('input', updateWorkletSpeed);

      // RAF controls
      rafPlayBtn.addEventListener('click', startRAF);
      rafStopBtn.addEventListener('click', stopRAF);
      rafStartSlider.addEventListener('input', updateRAFLoopPoints);
      rafEndSlider.addEventListener('input', updateRAFLoopPoints);
      rafSpeedSlider.addEventListener('input', updateRAFSpeed);

      // Initialize
      initAudio();
    </script>
  </body>
</html>

<!-- <!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loop Interpolation Demo</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 20px;
        max-width: 100vw;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }
      h1 {
        margin-bottom: 5px;
      }
      .controller {
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 10px;
        background-color: #f9f9f9;
      }
      .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background-color: #4caf50;
        color: white;
        font-size: 16px;
        cursor: pointer;
      }
      .btn:hover {
        background-color: #45a049;
      }
      .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .sliders {
        display: flex;
        flex-direction: column;
        gap: 30px;
        width: 100%;
        position: relative;
      }
      .slider-container {
        width: 100%;
        position: relative;
      }
      .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }
      .slider {
        width: 100%;
        height: 30px;
      }
      .info {
        margin-top: 10px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>Loop Interpolation Demo</h1>
    <div id="status">Loading audio...</div>

    <div class="controller">
      <h2>1. AudioWorkletNode Implementation</h2>
      <div class="controls">
        <button id="worklet-play" class="btn" disabled>Play</button>
        <button id="worklet-stop" class="btn" disabled>Stop</button>
        <div>
          <label for="worklet-speed">Interpolation Speed:</label>
          <input
            type="range"
            id="worklet-speed"
            min="0.001"
            max="0.2"
            step="0.001"
            value="0.05"
          />
          <span id="worklet-speed-value">0.05</span>
        </div>
      </div>
      <div class="sliders">
        <div class="slider-container">
          <div class="slider-label">
            <label for="worklet-start">Loop Start:</label>
            <span id="worklet-start-value">0.00</span>s
          </div>
          <input
            type="range"
            id="worklet-start"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="0"
          />
        </div>
        <div class="slider-container">
          <div class="slider-label">
            <label for="worklet-end">Loop End:</label>
            <span id="worklet-end-value">1.00</span>s
          </div>
          <input
            type="range"
            id="worklet-end"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="1"
          />
        </div>
      </div>
      <div class="info" id="worklet-info"></div>
    </div>

    <div class="controller">
      <h2>2. RequestAnimationFrame Implementation</h2>
      <div class="controls">
        <button id="raf-play" class="btn" disabled>Play</button>
        <button id="raf-stop" class="btn" disabled>Stop</button>
        <div>
          <label for="raf-speed">Interpolation Speed:</label>
          <input
            type="range"
            id="raf-speed"
            min="0.001"
            max="0.2"
            step="0.001"
            value="0.05"
          />
          <span id="raf-speed-value">0.05</span>
        </div>
      </div>
      <div class="sliders">
        <div class="slider-container">
          <div class="slider-label">
            <label for="raf-start">Loop Start:</label>
            <span id="raf-start-value">0.00</span>s
          </div>
          <input
            type="range"
            id="raf-start"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="0"
          />
        </div>
        <div class="slider-container">
          <div class="slider-label">
            <label for="raf-end">Loop End:</label>
            <span id="raf-end-value">1.00</span>s
          </div>
          <input
            type="range"
            id="raf-end"
            class="slider"
            min="0"
            max="1"
            step="0.001"
            value="1"
          />
        </div>
      </div>
      <div class="info" id="raf-info"></div>
    </div>

    <script>
      // Global variables
      let audioCtx;
      let buffer;
      let minLoopDuration = 0.004; // ~4ms, approx C4 period (261.63 Hz -> ~3.82ms)
      const statusElement = document.getElementById('status');

      // Worklet variables
      let workletNode;
      const workletPlayBtn = document.getElementById('worklet-play');
      const workletStopBtn = document.getElementById('worklet-stop');
      const workletStartSlider = document.getElementById('worklet-start');
      const workletEndSlider = document.getElementById('worklet-end');
      const workletStartValue = document.getElementById('worklet-start-value');
      const workletEndValue = document.getElementById('worklet-end-value');
      const workletSpeedSlider = document.getElementById('worklet-speed');
      const workletSpeedValue = document.getElementById('worklet-speed-value');
      const workletInfo = document.getElementById('worklet-info');

      // RAF variables
      let rafSource;
      let rafIsPlaying = false;
      let rafCurrentLoopStart = 0;
      let rafCurrentLoopEnd = 1;
      let rafTargetLoopStart = 0;
      let rafTargetLoopEnd = 1;
      let rafInterpolationSpeed = 0.05;

      const rafPlayBtn = document.getElementById('raf-play');
      const rafStopBtn = document.getElementById('raf-stop');
      const rafStartSlider = document.getElementById('raf-start');
      const rafEndSlider = document.getElementById('raf-end');
      const rafStartValue = document.getElementById('raf-start-value');
      const rafEndValue = document.getElementById('raf-end-value');
      const rafSpeedSlider = document.getElementById('raf-speed');
      const rafSpeedValue = document.getElementById('raf-speed-value');
      const rafInfo = document.getElementById('raf-info');

      // Initialize audio
      async function initAudio() {
        try {
          statusElement.textContent = 'Initializing audio context...';

          audioCtx = new AudioContext();

          // Load audio file
          statusElement.textContent = 'Loading audio file...';
          const response = await fetch('piano-c4.mp3');
          buffer = await audioCtx.decodeAudioData(await response.arrayBuffer());

          // Update UI with buffer duration
          const duration = buffer.duration;

          workletStartSlider.max = duration;
          workletEndSlider.max = duration;
          workletEndSlider.value = duration;
          workletEndValue.textContent = duration.toFixed(2);

          rafStartSlider.max = duration;
          rafEndSlider.max = duration;
          rafEndSlider.value = duration;
          rafEndValue.textContent = duration.toFixed(2);

          // Enable buttons
          workletPlayBtn.disabled = false;
          rafPlayBtn.disabled = false;

          statusElement.textContent = `Audio loaded: ${duration.toFixed(2)}s duration`;

          // Initialize worklet
          try {
            statusElement.textContent = 'Loading AudioWorklet...';
            await audioCtx.audioWorklet.addModule('loop-interpolator.js');
            statusElement.textContent = 'Ready to play!';
          } catch (err) {
            console.error('Error loading worklet:', err);
            workletInfo.innerHTML = `<strong>Error:</strong> Could not load AudioWorklet: ${err.message}<br>
            Make sure you have the file "loop-interpolator.js" in the same directory.`;
            workletInfo.style.color = 'red';
            statusElement.textContent =
              'AudioWorklet failed to load. RAF implementation still available.';
          }
        } catch (err) {
          console.error('Error initializing audio:', err);
          statusElement.textContent = `Error: ${err.message}`;
          statusElement.style.color = 'red';
        }
      }

      // --- WORKLET IMPLEMENTATION ---

      function setupWorkletNode() {
        // Create and configure worklet node
        workletNode = new AudioWorkletNode(audioCtx, 'loop-interpolator');
        workletNode.connect(audioCtx.destination);

        // Set initial parameters
        const startValue = parseFloat(workletStartSlider.value);
        const endValue = parseFloat(workletEndSlider.value);
        const speedValue = parseFloat(workletSpeedSlider.value);

        workletNode.parameters.get('targetLoopStart').value = startValue;
        workletNode.parameters.get('targetLoopEnd').value = endValue;
        workletNode.parameters.get('interpolationSpeed').value = speedValue;

        // Send buffer data to worklet
        workletNode.port.postMessage({
          type: 'setBuffer',
          buffer: buffer,
        });

        return workletNode;
      }

      function startWorklet() {
        if (!audioCtx) return;

        // Resume audio context if needed
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // Setup worklet if not already created
        if (!workletNode) {
          try {
            workletNode = setupWorkletNode();
          } catch (err) {
            console.error('Error setting up worklet:', err);
            workletInfo.innerHTML = `<strong>Error:</strong> ${err.message}`;
            workletInfo.style.color = 'red';
            return;
          }
        }

        // Start playback
        workletNode.port.postMessage({ type: 'play' });

        // Update UI
        workletPlayBtn.disabled = true;
        workletStopBtn.disabled = false;
      }

      function stopWorklet() {
        if (!workletNode) return;

        // Stop playback
        workletNode.port.postMessage({ type: 'stop' });

        // Update UI
        workletPlayBtn.disabled = false;
        workletStopBtn.disabled = true;
      }

      function updateWorkletLoopPoints() {
        if (!workletNode) return;

        let startValue = parseFloat(workletStartSlider.value);
        let endValue = parseFloat(workletEndSlider.value);

        // Enforce minimum loop duration
        if (endValue - startValue < minLoopDuration) {
          if (this === workletStartSlider) {
            startValue = endValue - minLoopDuration;
            workletStartSlider.value = startValue;
          } else if (this === workletEndSlider) {
            endValue = startValue + minLoopDuration;
            workletEndSlider.value = endValue;
          }
        }

        // Update parameters
        workletNode.parameters.get('targetLoopStart').value = startValue;
        workletNode.parameters.get('targetLoopEnd').value = endValue;

        // Update display values
        workletStartValue.textContent = startValue.toFixed(3);
        workletEndValue.textContent = endValue.toFixed(3);
        workletInfo.textContent = `Loop duration: ${(endValue - startValue).toFixed(3)}s`;
      }

      function updateWorkletSpeed() {
        const speedValue = parseFloat(workletSpeedSlider.value);
        workletSpeedValue.textContent = speedValue.toFixed(3);

        if (workletNode) {
          workletNode.parameters.get('interpolationSpeed').value = speedValue;
        }
      }

      // --- RAF IMPLEMENTATION ---

      function startRAF() {
        if (!audioCtx) return;

        // Resume audio context if needed
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        // Stop existing source if playing
        if (rafIsPlaying && rafSource) {
          rafSource.stop();
        }

        // Create new source
        rafSource = audioCtx.createBufferSource();
        rafSource.buffer = buffer;
        rafSource.loop = true;
        rafSource.connect(audioCtx.destination);

        // Get current values
        rafTargetLoopStart = parseFloat(rafStartSlider.value);
        rafTargetLoopEnd = parseFloat(rafEndSlider.value);
        rafCurrentLoopStart = rafTargetLoopStart;
        rafCurrentLoopEnd = rafTargetLoopEnd;
        rafInterpolationSpeed = parseFloat(rafSpeedSlider.value);

        // Set initial loop points
        rafSource.loopStart = rafCurrentLoopStart;
        rafSource.loopEnd = rafCurrentLoopEnd;

        // Start playback
        rafSource.start();
        rafIsPlaying = true;

        // Start animation frame loop
        requestAnimationFrame(updateRAFLoop);

        // Update UI
        rafPlayBtn.disabled = true;
        rafStopBtn.disabled = false;
      }

      function stopRAF() {
        if (!rafIsPlaying) return;

        // Stop source
        if (rafSource) {
          rafSource.stop();
        }

        rafIsPlaying = false;

        // Update UI
        rafPlayBtn.disabled = false;
        rafStopBtn.disabled = true;
      }

      function updateRAFLoop() {
        if (!rafIsPlaying) return;

        // Interpolate values
        rafCurrentLoopStart +=
          (rafTargetLoopStart - rafCurrentLoopStart) * rafInterpolationSpeed;
        rafCurrentLoopEnd +=
          (rafTargetLoopEnd - rafCurrentLoopEnd) * rafInterpolationSpeed;

        // Apply to source
        if (rafSource) {
          rafSource.loopStart = rafCurrentLoopStart;
          rafSource.loopEnd = rafCurrentLoopEnd;
        }

        // Update info
        rafInfo.textContent = `Current loop: ${rafCurrentLoopStart.toFixed(3)}s - ${rafCurrentLoopEnd.toFixed(3)}s (${(rafCurrentLoopEnd - rafCurrentLoopStart).toFixed(3)}s duration)`;

        // Continue loop
        requestAnimationFrame(updateRAFLoop);
      }

      function updateRAFLoopPoints() {
        let startValue = parseFloat(rafStartSlider.value);
        let endValue = parseFloat(rafEndSlider.value);

        // Enforce minimum loop duration
        if (endValue - startValue < minLoopDuration) {
          if (this === rafStartSlider) {
            startValue = endValue - minLoopDuration;
            rafStartSlider.value = startValue;
          } else if (this === rafEndSlider) {
            endValue = startValue + minLoopDuration;
            rafEndSlider.value = endValue;
          }
        }

        // Update target values
        rafTargetLoopStart = startValue;
        rafTargetLoopEnd = endValue;

        // Update display values
        rafStartValue.textContent = startValue.toFixed(3);
        rafEndValue.textContent = endValue.toFixed(3);
      }

      function updateRAFSpeed() {
        rafInterpolationSpeed = parseFloat(rafSpeedSlider.value);
        rafSpeedValue.textContent = rafInterpolationSpeed.toFixed(3);
      }

      // --- EVENT LISTENERS ---

      // Worklet controls
      workletPlayBtn.addEventListener('click', startWorklet);
      workletStopBtn.addEventListener('click', stopWorklet);
      workletStartSlider.addEventListener('input', updateWorkletLoopPoints);
      workletEndSlider.addEventListener('input', updateWorkletLoopPoints);
      workletSpeedSlider.addEventListener('input', updateWorkletSpeed);

      // RAF controls
      rafPlayBtn.addEventListener('click', startRAF);
      rafStopBtn.addEventListener('click', stopRAF);
      rafStartSlider.addEventListener('input', updateRAFLoopPoints);
      rafEndSlider.addEventListener('input', updateRAFLoopPoints);
      rafSpeedSlider.addEventListener('input', updateRAFSpeed);

      // Initialize
      initAudio();
    </script>
  </body>
</html> -->
