<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Worklet Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
      }
      .controls {
        margin: 20px 0;
      }
      label {
        display: inline-block;
        width: 150px;
      }
      input[type='range'] {
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h1>Audio Worklet Test</h1>

    <div class="controls">
      <button id="loadSample">Load Sample</button>
      <button id="playButton" disabled>Play</button>
      <button id="stopButton" disabled>Stop</button>
      <button id="loopToggle" disabled>Enable Loop</button>
    </div>

    <div class="controls">
      <div>
        <label for="startRange">Start:</label>
        <input
          type="range"
          id="startRange"
          min="0"
          max="1"
          step="0.01"
          value="0"
        />
        <span id="startValue">0</span>
      </div>
      <div>
        <label for="endRange">End:</label>
        <input
          type="range"
          id="endRange"
          min="0"
          max="1"
          step="0.01"
          value="1"
        />
        <span id="endValue">1</span>
      </div>
      <div>
        <label for="loopStartRange">Loop Start:</label>
        <input
          type="range"
          id="loopStartRange"
          min="0"
          max="1"
          step="0.005"
          value="0"
        />
        <span id="loopStartValue">0</span>
      </div>
      <div>
        <label for="loopEndRange">Loop End:</label>
        <input
          type="range"
          id="loopEndRange"
          min="0"
          max="1"
          step="0.005"
          value="1"
        />
        <span id="loopEndValue">1</span>
      </div>
      <div>
        <label for="playbackRateRange">Playback Rate:</label>
        <input
          type="range"
          id="playbackRateRange"
          min="0.1"
          max="4"
          step="0.05"
          value="1"
        />
        <span id="playbackRateValue">1</span>
      </div>
      <div>
        <label for="interpolationSpeedRange">Interpolation Speed:</label>
        <input
          type="range"
          id="interpolationSpeedRange"
          min="0.001"
          max="0.2"
          step="0.001"
          value="0.05"
        />
        <span id="interpolationSpeedValue">0.05</span>
      </div>
    </div>

    <div>
      <p>Playback position: <span id="positionDisplay">0</span> seconds</p>
    </div>

    <script>
      // Main audio context and nodes
      let audioContext;
      let sourceNode;
      let audioBuffer;
      let isLooping = false;

      // Initialize the audio context and worklet
      async function initAudio() {
        try {
          audioContext = new AudioContext();
          await audioContext.audioWorklet.addModule('source-processor.js');

          document.getElementById('loadSample').disabled = false;
          console.log('Audio worklet loaded successfully');
        } catch (error) {
          console.error('Error initializing audio worklet:', error);
        }
      }

      // Load sample (using test buffer for this example)
      async function loadSample() {
        try {
          // Create a test buffer
          const path = '/audiofiles/bjur.wav';

          const response = await fetch(path);
          const arrayBuffer = await response.arrayBuffer();
          audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          // Extract channel data for the worklet
          const channelData = [];
          for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
            channelData.push(audioBuffer.getChannelData(i));
          }

          // Enable playback controls
          document.getElementById('playButton').disabled = false;
          document.getElementById('loopToggle').disabled = false;
          document.getElementById('startRange').max = audioBuffer.duration;
          document.getElementById('endRange').max = audioBuffer.duration;
          document.getElementById('endRange').value = audioBuffer.duration;
          document.getElementById('endValue').textContent =
            audioBuffer.duration.toFixed(2);
          document.getElementById('loopStartRange').max = audioBuffer.duration;
          document.getElementById('loopEndRange').max = audioBuffer.duration;
          document.getElementById('loopEndRange').value = audioBuffer.duration;
          document.getElementById('loopEndValue').textContent =
            audioBuffer.duration.toFixed(2);

          console.log('Sample loaded successfully');
        } catch (error) {
          console.error('Error loading sample:', error);
        }
      }

      // Play the audio using the worklet
      function playAudio() {
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        // Create source node (or release existing one)
        if (sourceNode) {
          sourceNode.port.postMessage({ type: 'stop' });
          sourceNode.port.postMessage({ type: 'release' });
        }

        // Create new source node
        sourceNode = new AudioWorkletNode(audioContext, 'source-processor', {
          outputChannelCount: [audioBuffer.numberOfChannels],
        });

        // Extract channel data
        const channelData = [];
        for (let i = 0; i < audioBuffer.numberOfChannels; i++) {
          channelData.push(audioBuffer.getChannelData(i));
        }

        // Send buffer to the worklet
        sourceNode.port.postMessage({
          type: 'setBuffer',
          buffer: channelData,
          sampleRate: audioBuffer.sampleRate,
        });

        // Set up position updates
        sourceNode.port.postMessage({
          type: 'streamPosition',
          enabled: true,
          interval: 5,
        });

        // Connect node to output
        sourceNode.connect(audioContext.destination);

        // Set initial parameters
        updateWorkletParameters();

        // Start playback
        sourceNode.port.postMessage({ type: 'play' });
        if (isLooping) {
          sourceNode.port.postMessage({ type: 'enableLooping' });
        }

        // Enable stop button
        document.getElementById('playButton').disabled = true;
        document.getElementById('stopButton').disabled = false;

        // Listen for updates from worklet
        sourceNode.port.onmessage = (event) => {
          if (event.data.type === 'positionUpdate') {
            document.getElementById('positionDisplay').textContent =
              event.data.position.toFixed(2);
          } else if (event.data.type === 'ended') {
            document.getElementById('playButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
          }
        };
      }

      // Stop playback
      function stopAudio() {
        if (sourceNode) {
          sourceNode.port.postMessage({ type: 'stop' });
          document.getElementById('playButton').disabled = false;
          document.getElementById('stopButton').disabled = true;
        }
      }

      // Toggle looping
      function toggleLoop() {
        isLooping = !isLooping;
        const loopButton = document.getElementById('loopToggle');

        if (isLooping) {
          loopButton.textContent = 'Disable Loop';
          if (sourceNode) {
            sourceNode.port.postMessage({ type: 'enableLooping' });
          }
        } else {
          loopButton.textContent = 'Enable Loop';
          if (sourceNode) {
            sourceNode.port.postMessage({ type: 'disableLooping' });
          }
        }
      }

      // Update worklet parameters
      function updateWorkletParameters() {
        if (!sourceNode) return;

        // Get values from UI
        const start = parseFloat(document.getElementById('startRange').value);
        const end = parseFloat(document.getElementById('endRange').value);
        const loopStart = parseFloat(
          document.getElementById('loopStartRange').value
        );
        const loopEnd = parseFloat(
          document.getElementById('loopEndRange').value
        );
        const playbackRate = parseFloat(
          document.getElementById('playbackRateRange').value
        );
        const interpolationSpeed = parseFloat(
          document.getElementById('interpolationSpeedRange').value
        );

        // Update parameters
        sourceNode.parameters
          .get('targetStart')
          .setValueAtTime(start, audioContext.currentTime);
        sourceNode.parameters
          .get('targetEnd')
          .setValueAtTime(end, audioContext.currentTime);
        sourceNode.parameters
          .get('targetLoopStart')
          .setValueAtTime(loopStart, audioContext.currentTime);
        sourceNode.parameters
          .get('targetLoopEnd')
          .setValueAtTime(loopEnd, audioContext.currentTime);
        sourceNode.parameters
          .get('targetPlaybackRate')
          .setValueAtTime(playbackRate, audioContext.currentTime);
        sourceNode.parameters
          .get('interpolationSpeed')
          .setValueAtTime(interpolationSpeed, audioContext.currentTime);
      }

      // Initialize on page load
      window.addEventListener('load', () => {
        // Set up event listeners
        document
          .getElementById('loadSample')
          .addEventListener('click', loadSample);
        document
          .getElementById('playButton')
          .addEventListener('click', playAudio);
        document
          .getElementById('stopButton')
          .addEventListener('click', stopAudio);
        document
          .getElementById('loopToggle')
          .addEventListener('click', toggleLoop);

        // Set up range input listeners
        const rangeInputs = document.querySelectorAll('input[type="range"]');
        rangeInputs.forEach((input) => {
          input.addEventListener('input', (e) => {
            // Update display value
            const valueDisplay = document.getElementById(`${e.target.id}Value`);
            if (valueDisplay) {
              valueDisplay.textContent = parseFloat(e.target.value).toFixed(2);
            }

            // Update worklet parameters
            updateWorkletParameters();
          });
        });

        // Initialize audio
        initAudio();
      });
    </script>
  </body>
</html>
