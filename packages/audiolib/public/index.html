<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sampler Element Demo</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Styling the custom element using parts */
      sampler-element::part(button) {
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      sampler-element::part(init-button) {
        background: #2196f3;
      }

      #keyboard {
        display: flex;
        height: 120px;
        margin: 20px 0;
      }

      .white-key {
        background: white;
        border: 1px solid #333;
        flex: 1;
        position: relative;
      }

      .black-key {
        background: black;
        position: absolute;
        width: 60%;
        height: 60%;
        top: 0;
        right: -30%;
        z-index: 1;
      }

      .white-key.active {
        background: #e0f7fa;
      }

      .black-key.active {
        background: #333;
      }
    </style>
  </head>
  <body>
    <h1>Sampler Element Demo</h1>

    <sampler-element polyphony="16" id="mySampler">
      <div>Use the buttons above to initialize and load a sample</div>
    </sampler-element>

    <div id="keyboard"></div>

    <div>
      <label>
        Loop Start: <span id="loopStartValue">0</span>s
        <input
          type="range"
          id="loopStart"
          min="0"
          max="1"
          step="0.01"
          value="0"
          disabled
        />
      </label>
    </div>

    <div>
      <label>
        Loop End: <span id="loopEndValue">0</span>s
        <input
          type="range"
          id="loopEnd"
          min="0"
          max="1"
          step="0.01"
          value="1"
          disabled
        />
      </label>
    </div>

    <div id="info">
      <p>Status: Waiting for initialization</p>
    </div>

    <script type="module">
      import { SamplerElement } from '../dist/index.js';

      const sampler = document.getElementById('mySampler');
      const loopStartSlider = document.getElementById('loopStart');
      const loopEndSlider = document.getElementById('loopEnd');
      const loopStartValue = document.getElementById('loopStartValue');
      const loopEndValue = document.getElementById('loopEndValue');
      const infoElement = document.getElementById('info');
      const keyboard = document.getElementById('keyboard');

      // Generate keyboard
      const createKeyboard = () => {
        const notes = 13; // One octave + C
        for (let i = 0; i < notes; i++) {
          const isBlack = [1, 3, 6, 8, 10].includes(i % 12);
          const note = 60 + i; // Start at middle C (MIDI 60)

          if (!isBlack) {
            const whiteKey = document.createElement('div');
            whiteKey.className = 'white-key';
            whiteKey.dataset.note = note.toString();

            whiteKey.addEventListener('mousedown', () => {
              whiteKey.classList.add('active');
              sampler.playNote(note);
            });

            whiteKey.addEventListener('mouseup', () => {
              whiteKey.classList.remove('active');
              sampler.stopNote(note);
            });

            whiteKey.addEventListener('mouseleave', () => {
              whiteKey.classList.remove('active');
              sampler.stopNote(note);
            });

            keyboard.appendChild(whiteKey);

            // Add black key if needed
            if ([0, 2, 4, 5, 7, 9, 11].includes(i % 12) && i < notes - 1) {
              const blackKey = document.createElement('div');
              blackKey.className = 'black-key';
              blackKey.dataset.note = (note + 1).toString();

              blackKey.addEventListener('mousedown', () => {
                blackKey.classList.add('active');
                sampler.playNote(note + 1);
              });

              blackKey.addEventListener('mouseup', () => {
                blackKey.classList.remove('active');
                sampler.stopNote(note + 1);
              });

              blackKey.addEventListener('mouseleave', () => {
                blackKey.classList.remove('active');
                sampler.stopNote(note + 1);
              });

              whiteKey.appendChild(blackKey);
            }
          }
        }
      };

      createKeyboard();

      // Event listeners
      sampler.addEventListener('sampler-initialized', () => {
        infoElement.innerHTML =
          '<p>Sampler initialized! Load a sample to begin.</p>';
      });

      sampler.addEventListener('sample-loaded', (e) => {
        const { duration } = e.detail;

        infoElement.innerHTML = `
        <p>Sample loaded: ${e.detail.filename}</p>
        <p>Duration: ${duration.toFixed(4)}s</p>
      `;

        // Enable loop controls
        loopStartSlider.disabled = false;
        loopEndSlider.disabled = false;
        loopEndSlider.value = '1';
        loopEndValue.textContent = duration.toFixed(2);
      });

      // Loop controls
      loopStartSlider.addEventListener('input', (e) => {
        const normalizedValue = parseFloat(e.target.value);
        const actualValue = normalizedValue * sampler.sampleDuration;
        loopStartValue.textContent = actualValue.toFixed(2);

        // Ensure start is before end
        if (normalizedValue >= parseFloat(loopEndSlider.value)) {
          loopEndSlider.value = Math.min(1, normalizedValue + 0.01).toString();
          const endValue =
            parseFloat(loopEndSlider.value) * sampler.sampleDuration;
          loopEndValue.textContent = endValue.toFixed(2);
          sampler.setLoopEnd(endValue);
        }

        sampler.setLoopStart(actualValue);
      });

      loopEndSlider.addEventListener('input', (e) => {
        const normalizedValue = parseFloat(e.target.value);
        const actualValue = normalizedValue * sampler.sampleDuration;
        loopEndValue.textContent = actualValue.toFixed(2);

        // Ensure end is after start
        if (normalizedValue <= parseFloat(loopStartSlider.value)) {
          loopStartSlider.value = Math.max(
            0,
            normalizedValue - 0.01
          ).toString();
          const startValue =
            parseFloat(loopStartSlider.value) * sampler.sampleDuration;
          loopStartValue.textContent = startValue.toFixed(2);
          sampler.setLoopStart(startValue);
        }

        sampler.setLoopEnd(actualValue);
      });

      // Keyboard controls
      document.addEventListener('keydown', (e) => {
        if (e.repeat) return;

        const keyMap = {
          a: 60,
          w: 61,
          s: 62,
          e: 63,
          d: 64,
          f: 65,
          t: 66,
          g: 67,
          y: 68,
          h: 69,
          u: 70,
          j: 71,
          k: 72,
        };

        const note = keyMap[e.key.toLowerCase()];
        if (note !== undefined) {
          document
            .querySelector(
              `.white-key[data-note="${note}"], .black-key[data-note="${note}"]`
            )
            ?.classList.add('active');
          sampler.playNote(note);
        }
      });

      document.addEventListener('keyup', (e) => {
        const keyMap = {
          a: 60,
          w: 61,
          s: 62,
          e: 63,
          d: 64,
          f: 65,
          t: 66,
          g: 67,
          y: 68,
          h: 69,
          u: 70,
          j: 71,
          k: 72,
        };

        const note = keyMap[e.key.toLowerCase()];
        if (note !== undefined) {
          document
            .querySelector(
              `.white-key[data-note="${note}"], .black-key[data-note="${note}"]`
            )
            ?.classList.remove('active');
          sampler.stopNote(note);
        }
      });
    </script>
  </body>
</html>
