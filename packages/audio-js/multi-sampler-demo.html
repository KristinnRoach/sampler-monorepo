<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Sampler Demo</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
        color: #333;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 32px;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .description {
        color: #7f8c8d;
        max-width: 600px;
        margin: 0 auto 30px;
        line-height: 1.6;
      }

      .instruments {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      @media (min-width: 768px) {
        .instruments {
          grid-template-columns: 1fr 1fr;
        }
      }

      .instrument-card {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      .card-header {
        background-color: #3498db;
        color: white;
        padding: 15px 20px;
        font-weight: 600;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-header.percussion {
        background-color: #e74c3c;
      }

      .card-body {
        padding: 20px;
      }

      .sequence-controls {
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
      }

      .sequence-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .sequence-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      button {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      button.primary {
        background-color: #3498db;
        color: white;
      }

      button.primary:hover {
        background-color: #2980b9;
      }

      button.secondary {
        background-color: #ecf0f1;
        color: #2c3e50;
      }

      button.secondary:hover {
        background-color: #bdc3c7;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .tempo-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      input[type='range'] {
        flex: 1;
      }

      footer {
        margin-top: 30px;
        text-align: center;
        color: #7f8c8d;
        font-size: 14px;
      }
    </style>

    <!-- Load AudioLib components -->
    <script src="AudioContextManager.js"></script>
    <script src="Voice.js"></script>
    <script src="Instrument.js"></script>
    <script src="SamplerWC.js"></script>
  </head>
  <body>
    <header>
      <h1>Multi-Sampler Demo</h1>
      <p class="description">
        This demo uses multiple Sampler Web Components to create a simple drum
        machine and melodic instrument. Start both instruments, then use the
        sequencer to create a pattern or play notes manually.
      </p>
    </header>

    <div class="instruments">
      <!-- Melodic Instrument Card -->
      <div class="instrument-card">
        <div class="card-header">
          Melodic Instrument
          <span class="sound-type">Piano</span>
        </div>
        <div class="card-body">
          <sampler-wc
            id="melodicSampler"
            polyphony="8"
            attack="0.01"
            decay="0.1"
            sustain="0.8"
            release="0.7"
            gain="0.7"
            sample-url="./assets/piano-c4.mp3"
          >
          </sampler-wc>
        </div>
      </div>

      <!-- Percussion Instrument Card -->
      <div class="instrument-card">
        <div class="card-header percussion">
          Percussion
          <span class="sound-type">Drums</span>
        </div>
        <div class="card-body">
          <sampler-wc
            id="percussionSampler"
            polyphony="4"
            attack="0.001"
            decay="0.05"
            sustain="0.2"
            release="0.3"
            gain="0.8"
            sample-url="./assets/snare-1.wav"
          >
          </sampler-wc>
        </div>
      </div>
    </div>

    <!-- Sequencer Controls -->
    <div class="sequence-controls">
      <div class="sequence-title">Pattern Sequencer</div>

      <div class="sequence-buttons">
        <button id="startSequenceBtn" class="primary" disabled>
          Start Sequence
        </button>
        <button id="stopSequenceBtn" class="secondary" disabled>Stop</button>
        <button id="clearSequenceBtn" class="secondary" disabled>Clear</button>
      </div>

      <div class="tempo-control">
        <span>Tempo:</span>
        <input
          type="range"
          id="tempoSlider"
          min="60"
          max="180"
          step="1"
          value="120"
          disabled
        />
        <span id="tempoValue">120 BPM</span>
      </div>
    </div>

    <footer>
      <p>
        Built with Audiolib and Web Components. Click "Start Audio" on both
        instruments to begin.
      </p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Get references to elements
        const melodicSampler = document.getElementById('melodicSampler');
        const percussionSampler = document.getElementById('percussionSampler');

        // Sequencer controls
        const startSequenceBtn = document.getElementById('startSequenceBtn');
        const stopSequenceBtn = document.getElementById('stopSequenceBtn');
        const clearSequenceBtn = document.getElementById('clearSequenceBtn');
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoValue = document.getElementById('tempoValue');

        // Sequencer state
        let isPlaying = false;
        let currentStep = 0;
        let sequenceInterval = null;
        let tempo = 120;

        // Simple sequences (can be made user-editable)
        const melodicSequence = [
          [60, 0, 0, 0, 64, 0, 67, 0], // C4, E4, G4 pattern
          [0, 0, 62, 0, 65, 0, 69, 0], // D4, F4, A4 pattern
        ];

        const drumSequence = [
          [36, 0, 0, 36, 0, 0, 36, 0], // Kick pattern (using note 36)
          [0, 0, 38, 0, 0, 0, 38, 0], // Snare pattern (using note 38)
        ];

        // Count ready samplers
        let readySamplers = 0;

        // Handle sampler ready events
        function handleSamplerReady() {
          readySamplers++;

          // Enable sequencer controls when both samplers are ready
          if (readySamplers >= 2) {
            startSequenceBtn.disabled = false;
            clearSequenceBtn.disabled = false;
            tempoSlider.disabled = false;
          }
        }

        melodicSampler.addEventListener('sampler-ready', handleSamplerReady);
        percussionSampler.addEventListener('sampler-ready', handleSamplerReady);

        // Start sequencer
        startSequenceBtn.addEventListener('click', () => {
          if (isPlaying) return;

          isPlaying = true;
          currentStep = 0;

          // Calculate step time based on tempo (in ms)
          const stepTime = ((60 / tempo) * 1000) / 2; // 8th notes

          sequenceInterval = setInterval(() => {
            playStep(currentStep);
            currentStep = (currentStep + 1) % 8; // 8 steps per pattern
          }, stepTime);

          startSequenceBtn.disabled = true;
          stopSequenceBtn.disabled = false;
        });

        // Stop sequencer
        stopSequenceBtn.addEventListener('click', () => {
          if (!isPlaying) return;

          isPlaying = false;
          clearInterval(sequenceInterval);

          // Release all notes
          melodicSampler.releaseAll();
          percussionSampler.releaseAll();

          startSequenceBtn.disabled = false;
          stopSequenceBtn.disabled = true;
        });

        // Clear sequence (just stops for now, could reset pattern if it were editable)
        clearSequenceBtn.addEventListener('click', () => {
          if (isPlaying) {
            stopSequenceBtn.click();
          }
        });

        // Update tempo
        tempoSlider.addEventListener('input', () => {
          tempo = parseInt(tempoSlider.value, 10);
          tempoValue.textContent = `${tempo} BPM`;

          // Update the interval if playing
          if (isPlaying) {
            clearInterval(sequenceInterval);
            const stepTime = ((60 / tempo) * 1000) / 2;

            sequenceInterval = setInterval(() => {
              playStep(currentStep);
              currentStep = (currentStep + 1) % 8;
            }, stepTime);
          }
        });

        // Play a single step of the sequence
        function playStep(step) {
          // Play melodic notes for this step
          for (let row = 0; row < melodicSequence.length; row++) {
            const note = melodicSequence[row][step];
            if (note > 0) {
              melodicSampler.triggerNote(note, 80);

              // Release after a short duration
              setTimeout(() => {
                melodicSampler.releaseNote(note);
              }, 300);
            }
          }

          // Play drum hits for this step
          for (let row = 0; row < drumSequence.length; row++) {
            const note = drumSequence[row][step];
            if (note > 0) {
              // Use different velocities for emphasis
              const velocity = step % 4 === 0 ? 100 : 80;
              percussionSampler.triggerNote(note, velocity);
            }
          }

          // Visual feedback (could highlight the active step)
        }

        // Utility function to load a sample into a sampler
        async function loadSample(sampler, url) {
          if (!sampler) return;

          try {
            await sampler.loadSample(url);
            console.log(`Loaded sample: ${url}`);
          } catch (error) {
            console.error(`Error loading sample ${url}:`, error);
          }
        }

        // Add keyboard control for testing
        document.addEventListener('keydown', (event) => {
          if (event.target.matches('input, textarea, select')) {
            return;
          }

          // Space to toggle sequence
          if (event.code === 'Space' && !event.repeat) {
            if (isPlaying) {
              stopSequenceBtn.click();
            } else {
              startSequenceBtn.click();
            }
            event.preventDefault();
          }

          // 1-8 keys to manually trigger pattern steps
          const stepKeys = [
            'Digit1',
            'Digit2',
            'Digit3',
            'Digit4',
            'Digit5',
            'Digit6',
            'Digit7',
            'Digit8',
          ];
          const stepIndex = stepKeys.indexOf(event.code);

          if (stepIndex >= 0 && !event.repeat) {
            playStep(stepIndex);
            event.preventDefault();
          }
        });

        // Load different drum samples for variety
        setTimeout(() => {
          // Demo sequence for melodic instrument (C major scale)
          document.addEventListener('keydown', (event) => {
            if (event.code === 'KeyZ' && !event.repeat) {
              const cMajorScale = [60, 62, 64, 65, 67, 69, 71, 72];

              let noteIndex = 0;
              const playNote = () => {
                if (noteIndex < cMajorScale.length) {
                  const note = cMajorScale[noteIndex];
                  melodicSampler.triggerNote(note, 80);

                  setTimeout(() => {
                    melodicSampler.releaseNote(note);
                    noteIndex++;
                    setTimeout(playNote, 200); // Gap between notes
                  }, 300); // Note duration
                }
              };

              playNote();
            }
          });
        }, 2000);
      });
    </script>
  </body>
</html>
