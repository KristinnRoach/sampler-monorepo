<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Web Components Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .component-container {
      margin: 20px 0;
      padding: 10px;
      border: 1px dashed #ccc;
      border-radius: 4px;
    }
    
    .keyboard {
      display: flex;
      height: 120px;
      margin: 20px 0;
      user-select: none;
    }
    
    .white-key {
      flex: 1;
      background: white;
      border: 1px solid #ccc;
      border-radius: 0 0 4px 4px;
      position: relative;
      z-index: 1;
    }
    
    .black-key {
      position: absolute;
      width: 60%;
      height: 60%;
      background: #333;
      border-radius: 0 0 4px 4px;
      z-index: 2;
      top: 0;
      transform: translateX(-50%);
    }
    
    .white-key.active {
      background: #e0e0e0;
    }
    
    .black-key.active {
      background: #555;
    }
    
    .connection-info {
      margin: 20px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Audio Web Components Test</h1>
  
  <div class="connection-info" id="connection-info">
    <p>Connection status will appear here</p>
  </div>
  
  <div class="component-container">
    <h2>Sampler</h2>
    <sampler-element id="sampler1"></sampler-element>
  </div>
  
  <div class="component-container">
    <h2>Output</h2>
    <output-element id="output1"></output-element>
  </div>
  
  <div class="component-container">
    <h2>Keyboard</h2>
    <div class="keyboard" id="keyboard">
      <!-- Keyboard will be generated by JavaScript -->
    </div>
  </div>
  
  <div class="controls">
    <button id="connect-btn">Connect Sampler to Output</button>
    <button id="disconnect-btn">Disconnect</button>
  </div>
  
  <script type="module">
    import { SamplerElement, OutputElement } from '../dist/index.js';
    
    // Get references to elements
    const sampler = document.getElementById('sampler1');
    const output = document.getElementById('output1');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const connectionInfo = document.getElementById('connection-info');
    
    // Generate keyboard
    const keyboard = document.getElementById('keyboard');
    const createKeyboard = () => {
      const notes = 13; // One octave + C
      const whiteKeyContainer = document.createElement('div');
      whiteKeyContainer.style.display = 'flex';
      whiteKeyContainer.style.position = 'relative';
      whiteKeyContainer.style.width = '100%';
      whiteKeyContainer.style.height = '100%';
      
      for (let i = 0; i < notes; i++) {
        const isBlack = [1, 3, 6, 8, 10].includes(i % 12);
        const note = 60 + i; // Start at middle C (MIDI 60)
        
        if (!isBlack) {
          const whiteKey = document.createElement('div');
          whiteKey.className = 'white-key';
          whiteKey.dataset.note = note.toString();
          
          whiteKey.addEventListener('mousedown', () => {
            whiteKey.classList.add('active');
            sampler.playNote(note);
          });
          
          whiteKey.addEventListener('mouseup', () => {
            whiteKey.classList.remove('active');
            sampler.stopNote(note);
          });
          
          whiteKey.addEventListener('mouseleave', () => {
            whiteKey.classList.remove('active');
            sampler.stopNote(note);
          });
          
          whiteKeyContainer.appendChild(whiteKey);
        }
      }
      
      // Add black keys on top
      for (let i = 0; i < notes; i++) {
        const isBlack = [1, 3, 6, 8, 10].includes(i % 12);
        const note = 60 + i;
        
        if (isBlack) {
          const blackKey = document.createElement('div');
          blackKey.className = 'black-key';
          blackKey.dataset.note = note.toString();
          
          // Position black key between white keys
          const position = i - 0.5;
          const whiteKeyWidth = 100 / (notes - 5); // 5 black keys in an octave
          blackKey.style.left = `${position * whiteKeyWidth}%`;
          
          blackKey.addEventListener('mousedown', () => {
            blackKey.classList.add('active');
            sampler.playNote(note);
          });
          
          blackKey.addEventListener('mouseup', () => {
            blackKey.classList.remove('active');
            sampler.stopNote(note);
          });
          
          blackKey.addEventListener('mouseleave', () => {
            blackKey.classList.remove('active');
            sampler.stopNote(note);
          });
          
          whiteKeyContainer.appendChild(blackKey);
        }
      }
      
      keyboard.appendChild(whiteKeyContainer);
    };
    
    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      
      const keyMap = {
        a: 60, // C
        w: 61, // C#
        s: 62, // D
        e: 63, // D#
        d: 64, // E
        f: 65, // F
        t: 66, // F#
        g: 67, // G
        y: 68, // G#
        h: 69, // A
        u: 70, // A#
        j: 71, // B
        k: 72, // C
      };
      
      const note = keyMap[e.key.toLowerCase()];
      if (note !== undefined) {
        document.querySelector(`.white-key[data-note="${note}"], .black-key[data-note="${note}"]`)?.classList.add('active');
        sampler.playNote(note);
      }
    });
    
    document.addEventListener('keyup', (e) => {
      const keyMap = {
        a: 60, // C
        w: 61, // C#
        s: 62, // D
        e: 63, // D#
        d: 64, // E
        f: 65, // F
        t: 66, // F#
        g: 67, // G
        y: 68, // G#
        h: 69, // A
        u: 70, // A#
        j: 71, // B
        k: 72, // C
      };
      
      const note = keyMap[e.key.toLowerCase()];
      if (note !== undefined) {
        document.querySelector(`.white-key[data-note="${note}"], .black-key[data-note="${note}"]`)?.classList.remove('active');
        sampler.stopNote(note);
      }
    });
    
    // Event listeners
    sampler.addEventListener('sampler-initialized', () => {
      connectionInfo.innerHTML = '<p>Sampler initialized</p>';
    });
    
    sampler.addEventListener('sample-loaded', (event) => {
      connectionInfo.innerHTML += `<p>Sample loaded: ${event.detail.fileName} (${event.detail.duration.toFixed(2)}s)</p>`;
    });
    
    output.addEventListener('output-initialized', () => {
      connectionInfo.innerHTML += '<p>Output initialized</p>';
    });
    
    // Connect/disconnect buttons
    connectBtn.addEventListener('click', () => {
      sampler.connect(output);
      connectionInfo.innerHTML += '<p>Connected sampler to output</p>';
    });
    
    disconnectBtn.addEventListener('click', () => {
      sampler.disconnect();
      connectionInfo.innerHTML += '<p>Disconnected sampler</p>';
    });
    
    // Create keyboard when DOM is loaded
    createKeyboard();
  </script>
</body>
</html>
